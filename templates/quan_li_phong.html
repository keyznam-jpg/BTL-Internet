{% extends "base.html" %}

{% block title %}Quan ly phong{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-500: #6366f1;
        --primary-600: #4f46e5;
        --primary-700: #4338ca;
        --emerald: #10b981;
        --amber: #f59e0b;
        --rose: #ef4444;
        --stone-50: #f9fafb;
        --stone-100: #f3f4f6;
        --stone-200: #e5e7eb;
        --stone-300: #d1d5db;
        --text-strong: #111827;
        --text-muted: #4b5563;
        --glass: rgba(255, 255, 255, 0.92);
    }

    body {
        background: radial-gradient(circle at 0% 0%, #eef2ff 0%, #e0f2fe 35%, #fdf2f8 70%, #ffffff 100%);
    }

    .room-page {
        position: relative;
        max-width: 1180px;
        margin: 26px auto 60px;
        padding: 32px 34px 48px;
        background: var(--glass);
        border-radius: 32px;
        border: 1px solid rgba(79, 70, 229, 0.16);
        box-shadow: 0 28px 60px rgba(79, 70, 229, 0.16);
        backdrop-filter: blur(18px);
        display: grid;
        gap: 28px;
    }

    .page-hero {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 16px;
        align-items: center;
    }

    .page-title {
        font-size: 30px;
        font-weight: 750;
        color: var(--text-strong);
        display: inline-flex;
        align-items: center;
        gap: 14px;
    }

    .page-title i {
        color: var(--primary-600);
        font-size: 28px;
    }

    .hero-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-primary {
        border: none;
        border-radius: 14px;
        padding: 12px 24px;
        font-weight: 650;
        font-size: 14px;
        color: #ffffff;
        background: linear-gradient(125deg, var(--primary-500), var(--primary-700));
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 34px rgba(99, 102, 241, 0.25);
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }

    .stat-card {
        background: rgba(255,255,255,0.92);
        border-radius: 20px;
        padding: 18px 22px;
        border: 1px solid rgba(79,70,229,0.14);
        box-shadow: 0 18px 36px rgba(79,70,229,0.12);
        display: grid;
        gap: 10px;
    }

    .stat-card h4 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
    }

    .stat-value {
        font-size: 30px;
        font-weight: 750;
        color: var(--text-strong);
    }

    .stat-foot {
        font-size: 13px;
        color: var(--text-muted);
    }

    .filters-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 22px 24px;
        border: 1px solid rgba(79,70,229,0.12);
        box-shadow: 0 20px 38px rgba(79,70,229,0.14);
        display: grid;
        gap: 18px;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
        align-items: center;
    }

    .search-input,
    .filter-select {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(99,102,241,0.2);
        padding: 11px 16px;
        font-size: 14px;
        color: var(--text-strong);
        background: rgba(255,255,255,0.95);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px rgba(99,102,241,0.15);
    }

    .status-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chip {
        border-radius: 999px;
        border: 1px solid rgba(99,102,241,0.25);
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        background: rgba(99,102,241,0.06);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }

    .chip:hover {
        border-color: var(--primary-500);
        color: var(--primary-600);
        background: rgba(99,102,241,0.14);
    }

    .chip.active {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 28px rgba(99,102,241,0.28);
    }

    .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
        gap: 20px;
    }

    .room-card {
        position: relative;
        border-radius: 26px;
        padding: 22px 24px;
        background: linear-gradient(160deg, rgba(255,255,255,0.95), rgba(239,246,255,0.9));
        border: 1px solid rgba(99,102,241,0.12);
        box-shadow: 0 24px 48px rgba(15,23,42,0.12);
        display: grid;
        gap: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .room-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 28px 52px rgba(15,23,42,0.18);
    }

    .room-head {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .room-name {
        font-size: 22px;
        font-weight: 750;
        color: var(--text-strong);
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .status-pill {
        border-radius: 999px;
        padding: 7px 14px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-empty { background: rgba(16,185,129,0.15); color: var(--emerald); }
    .status-booked { background: rgba(99,102,241,0.15); color: var(--primary-600); }
    .status-occupied { background: rgba(245,158,11,0.18); color: var(--amber); }
    .status-servicing { background: rgba(14,165,233,0.18); color: #0ea5e9; }
    .status-maintenance { background: rgba(239,68,68,0.18); color: var(--rose); }

    .room-body {
        display: grid;
        gap: 12px;
        font-size: 14px;
        color: var(--text-muted);
    }

    .room-body strong {
        color: var(--text-strong);
    }

    .booking-alert {
        border-radius: 16px;
        padding: 12px 14px;
        background: rgba(245,158,11,0.12);
        border: 1px solid rgba(245,158,11,0.28);
        color: #b45309;
        font-size: 13px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.3);
    }

    .room-footer {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }

    .room-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-link {
        border-radius: 12px;
        border: 1px solid rgba(99,102,241,0.2);
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        background: rgba(255,255,255,0.85);
        color: var(--primary-600);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-link:hover {
        border-color: var(--primary-500);
        background: rgba(99,102,241,0.14);
        color: var(--primary-700);
        box-shadow: 0 10px 22px rgba(99,102,241,0.18);
    }

    .counter-text {
        font-size: 13px;
        color: var(--text-muted);
    }

    .room-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15,23,42,0.45);
        backdrop-filter: blur(8px);
        z-index: 60;
    }

    .room-modal.active {
        display: flex;
    }

    .modal-card {
        width: min(520px, calc(100% - 40px));
        background: rgba(255,255,255,0.98);
        border-radius: 24px;
        padding: 26px;
        border: 1px solid rgba(99,102,241,0.18);
        box-shadow: 0 32px 60px rgba(67,56,202,0.25);
        display: grid;
        gap: 20px;
    }

    .modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-strong);
    }

    .modal-close {
        border: none;
        background: transparent;
        font-size: 18px;
        color: var(--text-muted);
        cursor: pointer;
    }

    .modal-form {
        display: grid;
        gap: 18px;
    }

    .form-field label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
    }

    .type-hint {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-muted);
        background: rgba(99,102,241,0.08);
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px dashed rgba(99,102,241,0.2);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .btn-neutral {
        border: 1px solid rgba(99,102,241,0.18);
        border-radius: 12px;
        padding: 10px 18px;
        background: rgba(99,102,241,0.08);
        color: var(--text-muted);
        font-weight: 600;
        cursor: pointer;
    }

    .btn-solid {
        border: none;
        border-radius: 12px;
        padding: 10px 22px;
        background: linear-gradient(120deg, var(--primary-500), var(--primary-700));
        color: #fff;
        font-weight: 650;
        cursor: pointer;
    }

    .hidden {
        display: none !important;
    }

    @media (max-width: 768px) {
        .room-page {
            padding: 26px 22px 40px;
        }
        .page-hero {
            flex-direction: column;
            align-items: flex-start;
        }
        .room-footer {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set total_rooms = phongs|length %}
{% set empty_rooms = phongs|selectattr('trang_thai','equalto','trong')|list|length %}
{% set occupied_rooms = phongs|selectattr('trang_thai','equalto','dang_o')|list|length %}
{% set booked_rooms = phongs|selectattr('trang_thai','equalto','da_dat')|list|length %}

<div class="room-page">
    <div class="page-hero">
        <div class="page-title">
            <i class="fas fa-door-open"></i>
            Quan ly phong
        </div>
        <div class="hero-actions">
            <button class="btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Them phong moi
            </button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <h4>Tong so phong</h4>
            <div class="stat-value">{{ total_rooms }}</div>
            <div class="stat-foot">Tong cong cac phong trong he thong</div>
        </div>
        <div class="stat-card">
            <h4>Dang co khach</h4>
            <div class="stat-value">{{ occupied_rooms }}</div>
            <div class="stat-foot">{{ ((occupied_rooms / total_rooms)*100)|round(1) if total_rooms else 0 }}% cong suat hien tai</div>
        </div>
        <div class="stat-card">
            <h4>Da dat truoc</h4>
            <div class="stat-value">{{ booked_rooms }}</div>
            <div class="stat-foot">Phong da khoa cho lich sap toi</div>
        </div>
        <div class="stat-card">
            <h4>San sang don khach</h4>
            <div class="stat-value">{{ empty_rooms }}</div>
            <div class="stat-foot">Phong trong va co the sap xep ngay</div>
        </div>
    </div>

    <div class="filters-card">
        <div class="filters-grid">
            <div>
                <label for="filterSearch" class="sr-only">Tim phong</label>
                <input id="filterSearch" type="search" class="search-input" placeholder="Tim theo so phong, loai phong hoac ten khach...">
            </div>
            <div>
                <label for="filterLoai" class="sr-only">Loc theo loai phong</label>
                <select id="filterLoai" class="filter-select">
                    <option value="all">Tat ca loai phong</option>
                    {% for loai in loai_phongs %}
                    <option value="{{ loai.id }}">{{ loai.ten }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="counter-text">
                Dang hien <strong id="totalRooms">{{ total_rooms }}</strong> phong phu hop dieu kien loc.
            </div>
        </div>
        <div class="status-chips">
            <button type="button" class="chip active" data-status-filter="all">Tat ca</button>
            <button type="button" class="chip" data-status-filter="trong">Trong</button>
            <button type="button" class="chip" data-status-filter="da_dat">Da dat</button>
            <button type="button" class="chip" data-status-filter="dang_o">Dang o</button>
            <button type="button" class="chip" data-status-filter="dang_don">Dang don</button>
            <button type="button" class="chip" data-status-filter="bao_tri">Bao tri</button>
        </div>
    </div>

    <div class="rooms-grid" id="roomsGrid">
        {% for phong in phongs %}
        {% set booking = room_booking_status.get(phong.id) %}
        <div class="room-card"
             data-room-card
             data-status="{{ phong.trang_thai }}"
             data-type="{{ phong.loai_id }}"
             data-room-name="{{ phong.ten|lower }}"
             data-type-name="{{ phong.loai.ten|lower }}"
             data-guest="{{ booking.khachhang.ho_ten|lower if booking else '' }}">

            <div class="room-head">
                <div class="room-name">
                    <i class="fas fa-bed"></i>
                    {{ phong.ten }}
                </div>
                <div class="status-pill
                    {% if phong.trang_thai == 'trong' %} status-empty
                    {% elif phong.trang_thai == 'da_dat' %} status-booked
                    {% elif phong.trang_thai == 'dang_o' %} status-occupied
                    {% elif phong.trang_thai == 'dang_don' %} status-servicing
                    {% else %} status-maintenance
                    {% endif %}
                ">
                    <i class="fas fa-circle"></i>
                    {% if phong.trang_thai == 'trong' %}
                        San sang
                    {% elif phong.trang_thai == 'da_dat' %}
                        Da dat truoc
                    {% elif phong.trang_thai == 'dang_o' %}
                        Dang co khach
                    {% elif phong.trang_thai == 'dang_don' %}
                        Dang ve sinh
                    {% else %}
                        Bao tri
                    {% endif %}
                </div>
            </div>

            <div class="room-body">
                <div>
                    <strong>Loai phong:</strong> {{ phong.loai.ten }} &middot; toi da {{ phong.loai.so_nguoi_toi_da }} nguoi
                </div>
                <div>
                    <strong>Gia niem yet:</strong> {{ phong.loai.gia|vnd }}
                </div>
                {% if booking %}
                <div class="booking-alert">
                    <strong>Dang co khach:</strong> {{ booking.khachhang.ho_ten }}<br>
                    Luu tru den {{ booking.ngay_tra.strftime('%d/%m/%Y %H:%M') }}
                </div>
                {% else %}
                <div>
                    <strong>Tinh trang lich:</strong> Chua co dat phong gan nhat
                </div>
                {% endif %}
            </div>

            <div class="room-footer">
                <div class="counter-text">
                    Ma phong: {{ phong.id }} &middot; Ma loai: {{ phong.loai_id }}
                </div>
                <div class="room-actions">
                    {% if booking %}
                    <a class="btn-link" href="{{ url_for('gia_han_phong', dat_id=booking.id) }}">
                        <i class="fas fa-clock"></i>
                        Gia han
                    </a>
                    {% endif %}
                    <button class="btn-link" onclick="openEditModal({{ phong.id }})">
                        <i class="fas fa-pen"></i>
                        Chinh sua
                    </button>
                    <button class="btn-link" onclick="confirmDelete({{ phong.id }}, '{{ phong.ten }}')">
                        <i class="fas fa-trash"></i>
                        Xoa
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<div class="room-modal" id="roomModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
        <div class="modal-head">
            <div class="modal-title" id="modalTitle">Them phong moi</div>
            <button class="modal-close" onclick="closeModal()" aria-label="Dong">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="roomForm" class="modal-form" method="POST" action="{{ url_for('them_phong') }}">
            <div class="form-field">
                <label for="so_phong">So phong</label>
                <input id="so_phong" name="so_phong" class="form-control" required placeholder="VD: 401">
            </div>
            <div class="form-field">
                <label for="loai_id">Loai phong</label>
                <select id="loai_id" name="loai_id" class="filter-select" required onchange="updateTypeHint()">
                    <option value="">-- Chon loai phong --</option>
                    {% for loai in loai_phongs %}
                    <option value="{{ loai.id }}" data-price="{{ loai.gia }}" data-capacity="{{ loai.so_nguoi_toi_da }}">
                        {{ loai.ten }} &middot; {{ loai.gia|vnd }}/dem
                    </option>
                    {% endfor %}
                </select>
                <div class="type-hint" id="typeHint">
                    Chon loai phong de xem gia niem yet va suc chua.
                </div>
            </div>
            <div class="form-field">
                <label for="trang_thai">Trang thai</label>
                <select id="trang_thai" name="trang_thai" class="filter-select" required>
                    <option value="trong">San sang don khach</option>
                    <option value="da_dat">Da dat truoc</option>
                    <option value="dang_o">Dang co khach</option>
                    <option value="dang_don">Dang don dep</option>
                    <option value="bao_tri">Bao tri</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-neutral" onclick="closeModal()">Huy</button>
                <button type="submit" class="btn-solid">
                    <i class="fas fa-save"></i>
                    Luu phong
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const rooms = {{ rooms_payload|tojson }};
const loaiPhongs = {{ loai_phongs_payload|tojson }};

const filterState = {
    status: 'all',
    type: 'all',
    search: ''
};

const roomCards = Array.from(document.querySelectorAll('[data-room-card]'));
const statusChips = document.querySelectorAll('[data-status-filter]');
const filterTypeSelect = document.getElementById('filterLoai');
const filterSearchInput = document.getElementById('filterSearch');
const totalRoomsEl = document.getElementById('totalRooms');

function normalise(text) {
    return (text || '').toString().toLowerCase();
}

function applyFilters() {
    let visibleCount = 0;
    const searchTerm = normalise(filterState.search);

    roomCards.forEach(card => {
        const cardStatus = card.dataset.status;
        const cardType = card.dataset.type;
        const name = card.dataset.roomName || '';
        const typeName = card.dataset.typeName || '';
        const guestName = card.dataset.guest || '';

        const statusMatch = filterState.status === 'all' || filterState.status === cardStatus;
        const typeMatch = filterState.type === 'all' || filterState.type === cardType;

        let searchMatch = true;
        if (searchTerm) {
            searchMatch =
                name.includes(searchTerm) ||
                typeName.includes(searchTerm) ||
                guestName.includes(searchTerm);
        }

        const shouldShow = statusMatch && typeMatch && searchMatch;
        card.classList.toggle('hidden', !shouldShow);
        if (shouldShow) {
            visibleCount += 1;
        }
    });

    totalRoomsEl.textContent = visibleCount;
}

statusChips.forEach(chip => {
    chip.addEventListener('click', () => {
        statusChips.forEach(btn => btn.classList.remove('active'));
        chip.classList.add('active');
        filterState.status = chip.dataset.statusFilter;
        applyFilters();
    });
});

filterTypeSelect.addEventListener('change', () => {
    filterState.type = filterTypeSelect.value;
    applyFilters();
});

filterSearchInput.addEventListener('input', (event) => {
    filterState.search = event.target.value;
    applyFilters();
});

applyFilters();

const roomModal = document.getElementById('roomModal');
const roomForm = document.getElementById('roomForm');
const modalTitle = document.getElementById('modalTitle');
const typeHint = document.getElementById('typeHint');

function updateTypeHint() {
    const select = document.getElementById('loai_id');
    const selected = select.options[select.selectedIndex];
    if (!selected || !selected.value) {
        typeHint.textContent = 'Chon loai phong de xem gia niem yet va suc chua.';
        return;
    }
    const price = selected.getAttribute('data-price');
    const capacity = selected.getAttribute('data-capacity');
    const priceText = Number(price || 0).toLocaleString('vi-VN');
    typeHint.textContent = `Gia niem yet: ${priceText} VND / dem Â· Suc chua: ${capacity} nguoi.`;
}

function openAddModal() {
    modalTitle.textContent = 'Them phong moi';
    roomForm.action = "{{ url_for('them_phong') }}";
    roomForm.reset();
    updateTypeHint();
    roomModal.classList.add('active');
    roomModal.setAttribute('aria-hidden', 'false');
}

function openEditModal(phongId) {
    const phong = rooms.find(item => item.id === phongId);
    if (!phong) {
        return;
    }
    modalTitle.textContent = `Chinh sua phong ${phong.ten}`;
    roomForm.action = "{{ url_for('sua_phong', phong_id=0) }}".replace('0', phongId);
    document.getElementById('so_phong').value = phong.ten;
    document.getElementById('loai_id').value = String(phong.loai_id);
    document.getElementById('trang_thai').value = phong.trang_thai;
    updateTypeHint();
    roomModal.classList.add('active');
    roomModal.setAttribute('aria-hidden', 'false');
}

function closeModal() {
    roomModal.classList.remove('active');
    roomModal.setAttribute('aria-hidden', 'true');
}

roomModal.addEventListener('click', (event) => {
    if (event.target === roomModal) {
        closeModal();
    }
});

document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && roomModal.classList.contains('active')) {
        closeModal();
    }
});

function confirmDelete(phongId, soPhong) {
    if (confirm(`Ban co chac muon xoa phong ${soPhong}? Chi xoa phong khong co dat phong dang hoat dong.`)) {
        const form = document.getElementById('deleteForm');
        form.action = "{{ url_for('xoa_phong', phong_id=0) }}".replace('0', phongId);
        form.submit();
    }
}

window.openAddModal = openAddModal;
window.openEditModal = openEditModal;
window.closeModal = closeModal;
window.confirmDelete = confirmDelete;
window.updateTypeHint = updateTypeHint;
</script>
{% endblock %}
