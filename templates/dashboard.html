{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">

<div class="dashboard-page">
  <div class="dashboard-greeting">
    <div class="greeting-card">
      <div class="greeting-main">
        <div class="greeting-copy">
          <h1 class="greeting-title">Xin chào, {{ current_user.ten }}!</h1>
          <p class="greeting-subtitle" id="dashboard-wish">Chúc bạn một ngày làm việc hiệu quả.</p>
        </div>
        <div class="greeting-meta" aria-live="polite">
          <span class="meta-time" id="dashboard-time"></span>
          <span class="meta-divider" aria-hidden="true">|</span>
          <span class="meta-date" id="dashboard-date"></span>
        </div>
      </div>
    </div>
  </div>
  <!-- Stats Grid - Statistics Cards -->
  <div class="stats-grid">
    <!-- Thẻ Check-in -->
    <a href="{{ url_for('nhan_phong') }}" class="stat-card-link">
      <div class="stat-card stat-card-blue">
        <div class="stat-header">
          <div class="stat-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
          </div>
          <h3 class="stat-title">Check-in hôm nay</h3>
        </div>
        <div class="stat-body">
          <p class="stat-number">{{ checkins_today }}</p>
          <span class="stat-label">lượt khách</span>
        </div>
        <div class="stat-footer">
          <span class="stat-action">Xem chi tiết</span>
        </div>
      </div>
    </a>

    <!-- Thẻ Check-out -->
    <a href="{{ url_for('nhan_phong') }}" class="stat-card-link">
      <div class="stat-card stat-card-orange">
        <div class="stat-header">
          <div class="stat-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </div>
          <h3 class="stat-title">Check-out hôm nay</h3>
        </div>
        <div class="stat-body">
          <p class="stat-number">{{ checkouts_today }}</p>
          <span class="stat-label">lượt khách</span>
        </div>
        <div class="stat-footer">
          <span class="stat-action">Xem chi tiết</span>
        </div>
      </div>
    </a>

    <!-- Thẻ Phòng đang ở -->
    <a href="{{ url_for('so_do_phong', trang_thai='dang_o') }}" class="stat-card-link">
      <div class="stat-card stat-card-green">
        <div class="stat-header">
          <div class="stat-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <h3 class="stat-title">Phòng có khách</h3>
        </div>
        <div class="stat-body">
          <p class="stat-number">{{ occupied_rooms }}<span class="stat-divider">/</span>{{ total_rooms }}</p>
          <span class="stat-label">phòng đang sử dụng</span>
        </div>
        <div class="stat-footer">
          <span class="stat-action">Sơ đồ phòng</span>
        </div>
      </div>
    </a>

    <!-- Thẻ Tin nhắn mới -->
    <a href="{{ url_for('tin_nhan') }}" class="stat-card-link">
      <div class="stat-card stat-card-purple messages-card">
        <div class="stat-header">
          <div class="stat-icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <h3 class="stat-title">Tin nhắn mới</h3>
        </div>
        <div class="stat-body">
          <div class="message-list">
            {% set recent = recent_unread_messages or [] %}
            {% set total_unread = total_unread_messages or 0 %}
            {% if recent %}
              {% for msg in recent[:3] %}
                <div class="message-item">
                  <div class="message-header">
                    <span class="message-room">{{ msg.datphong.phong.ten }}</span>
                    <span class="message-time">{{ msg.thoi_gian.strftime('%H:%M') }}</span>
                  </div>
                  <p class="message-content">{{ msg.noi_dung|truncate(40) }}</p>
                </div>
              {% endfor %}
              {% set displayed = [recent|length, 3]|min %}
              {% set remaining = total_unread - displayed %}
              {% if remaining > 0 %}
                <p class="message-more">+{{ remaining }} tin nhắn khác</p>
              {% endif %}
            {% else %}
              <div class="no-message">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>Không có tin nhắn mới</p>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="stat-footer">
          <span class="stat-action">Xem tất cả</span>
        </div>
      </div>
    </a>
  </div>

  <!-- Main Access Grid - Large Cards -->
  <div class="main-access-grid">
    <!-- Đặt Phòng - Always visible -->
    <a href="{{ url_for('dat_phong') }}" class="access-card access-card-purple">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Đặt Phòng</h3>
        <p class="card-description">Tạo đặt phòng mới</p>
      </div>
    </a>

    <!-- Nhận & Trả Phòng - Always visible -->
    <a href="{{ url_for('nhan_phong') }}" class="access-card access-card-pink">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
          <polyline points="10 17 15 12 10 7"></polyline>
          <line x1="15" y1="12" x2="3" y2="12"></line>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Nhận & Trả Phòng</h3>
        <p class="card-description">Check-in/Check-out</p>
      </div>
    </a>

    {% if current_user.loai == 'admin' %}
    <!-- REMOVED: Card Quản Lí Phòng đã bị xóa -->
    {% endif %}

    <!-- Sơ Đồ Phòng - Always visible -->
    <a href="{{ url_for('so_do_phong') }}" class="access-card access-card-green">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Sơ Đồ Phòng</h3>
        <p class="card-description">Xem tình trạng phòng</p>
      </div>
    </a>

    <!-- Khách Hàng - Always visible -->
    <a href="{{ url_for('khach_hang') }}" class="access-card access-card-orange">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Khách Hàng</h3>
        <p class="card-description">Danh sách khách hàng</p>
      </div>
    </a>

    {% if current_user.loai == 'admin' %}
    <!-- Quản Lí Dịch Vụ - Admin only -->
    <a href="{{ url_for('quan_li_dich_vu') }}" class="access-card access-card-teal">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m9-9h-6M7 12H1"></path>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Quản Lí Dịch Vụ</h3>
        <p class="card-description">Dịch vụ & giá</p>
      </div>
    </a>
    {% endif %}

    <!-- Quản Lí Hóa Đơn - Always visible -->
    <a href="{{ url_for('quan_li_hoa_don') }}" class="access-card access-card-indigo">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Quản Lí Hóa Đơn</h3>
        <p class="card-description">Thanh toán & hóa đơn</p>
      </div>
    </a>

    {% if current_user.loai == 'admin' %}
    <!-- Thống Kê - Admin only -->
    <a href="{{ url_for('thong_ke_doanh_thu') }}" class="access-card access-card-yellow">
      <div class="card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
      </div>
      <div class="card-content">
        <h3 class="card-title">Thống Kê</h3>
        <p class="card-description">Doanh thu & báo cáo</p>
      </div>
    </a>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    const dateEl = document.getElementById('dashboard-date');
    const timeEl = document.getElementById('dashboard-time');
    const wishEl = document.getElementById('dashboard-wish');
    if (!dateEl || !timeEl) {
      return;
    }

    const weekdays = ['Chủ nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
    const wishMessages = [
      { start: 5, end: 10, message: 'Buổi sáng năng lượng.' },
      { start: 10, end: 13, message: 'Giữ nhịp trưa hứng khởi.' },
      { start: 13, end: 17, message: 'Chiều làm việc thật tập trung.' },
      { start: 17, end: 21, message: 'Buổi tối thư thái, nhẹ nhàng.' },
      { start: 21, end: 24, message: 'Đêm muộn nhớ nghỉ ngơi nhé.' },
      { start: 0, end: 5, message: 'Giữ sức khỏe trong ca đêm.' }
    ];

    function pad(value) {
      return value.toString().padStart(2, '0');
    }

    function updateWish(hour) {
      if (!wishEl) {
        return;
      }
      const wish = wishMessages.find(({ start, end }) => hour >= start && hour < end);
      if (wish) {
        wishEl.textContent = wish.message;
      }
    }

    function updateClock() {
      const now = new Date();
      const weekday = weekdays[now.getDay()];
      const date = `${pad(now.getDate())}/${pad(now.getMonth() + 1)}/${now.getFullYear()}`;
      const time = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      dateEl.textContent = `${weekday}, ${date}`;
      timeEl.textContent = time;
      updateWish(now.getHours());
    }

    updateClock();
    setInterval(updateClock, 1000);
  })();
</script>

{% endblock %}
