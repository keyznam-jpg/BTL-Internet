{% extends "base.html" %}
{% block content %}
<a href="{{ url_for('nhan_vien') }}" class="back-link">← Quay lại danh sách nhân viên</a>
<h2>Hồ sơ nhân viên</h2>

<section class="card staff-detail-header">
  <div class="detail-avatar">
    <img src="{{ url_for('static', filename=nv.avatar_path) }}" alt="Ảnh nhân viên"
         onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/ttcn.png') }}';">
  </div>
  <div class="detail-main">
    <div class="detail-title">
      <h3>{{ nv.ten }}</h3>{% if salary_info.is_top %}
      <span class="top-badge">Top doanh thu tháng</span>{% endif %}
      <span class="role-chip {{ 'chip-admin' if nv.role_slug == 'admin' else 'chip-staff' }}">{{ nv.role_name }}</span>
    </div>
    <dl class="detail-meta">
      <div>
        <dt>Tên đăng nhập</dt>
        <dd>{{ nv.ten_dang_nhap }}</dd>
      </div>
      <div>
        <dt>Ngày vào làm</dt>
        <dd>{{ nv.ngay_vao_lam.strftime('%d/%m/%Y') if nv.ngay_vao_lam else '—' }}</dd>
      </div>
      <div>
        <dt>Khách phục vụ</dt>
        <dd>{{ overall_stats.khach_phuc_vu }}</dd>
      </div>
    </dl>
    <div class="detail-highlight">
      <div>
        <span class="label">Tổng doanh thu đảm nhiệm</span>
        <strong>{{ overall_stats.tong_doanh_thu|vnd }}</strong>
      </div>
      <div>
        <span class="label">Tổng đơn hoàn tất</span>
        <strong>{{ overall_stats.tong_hoa_don }}</strong>
      </div>
    </div>
  </div>
</section>

<section class="card permission-card" id="user-permission-card" data-user-id="{{ nv.id }}" data-update-endpoint="{{ url_for('cap_nhat_quyen_ca_nhan', nhanvien_id=nv.id) }}" data-personal='{{ personal_permissions|list|tojson }}'>
  <header class="permission-header">
    <div>
      <h3>Quyền truy cập</h3>
      <p>Vai trò hiện tại: <strong>{{ nv.role_name }}</strong>. Quyền cá nhân chỉ bổ sung thêm ngoài quyền của vai trò.</p>
    </div>
    <div class="permission-badges">
      <span class="badge badge-inherit">Theo vai trò</span>
      <span class="badge badge-personal">Cá nhân</span>
    </div>
  </header>
  <div class="permission-groups">
    {% for group_key, group_label, items in permission_groups %}
    <div class="permission-group">
      <h4>{{ group_label }}</h4>
      <div class="permission-items">
        {% for key, label in items %}
        {% set is_inherited = key in role_permissions %}
        {% set is_personal = key in personal_permissions %}
        <label class="permission-item {% if is_inherited %}inherited{% endif %} {% if is_personal %}personal{% endif %}" data-permission-key="{{ key }}">
          <div class="permission-info">
            <strong>{{ label }}</strong>
            {% set meta = permission_meta.get(key) %}
            {% if meta and meta.description %}
            <span class="hint">{{ meta.description }}</span>
            {% endif %}
          </div>
          <div class="permission-actions">
            <label class="switch">
              <input type="checkbox"
                     value="{{ key }}"
                     {% if is_personal %}checked{% endif %}
                     {% if is_inherited and not is_personal %}data-locked="true" disabled{% endif %}
                     data-user-permission-toggle>
              <span class="slider"></span>
            </label>
            <span class="badge badge-inherit action-inherit">Vai trò</span>
            <span class="badge badge-personal action-personal">Cá nhân</span>
          </div>
        </label>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<div class="stats-grid">
  <section class="card stats-card">
    <header>
      <span class="stats-subtitle">Tổng kết</span>
      <h3>Hiệu suất tích luỹ</h3>
    </header>
    <div class="stats-list">
      <div>
        <span>Tiền phòng</span>
        <strong>{{ overall_stats.tong_tien_phong|vnd }}</strong>
      </div>
      <div>
        <span>Tiền dịch vụ</span>
        <strong>{{ overall_stats.tong_tien_dv|vnd }}</strong>
      </div>
      <div>
        <span>Phí phạt</span>
        <strong>{{ overall_stats.tong_tien_phat|vnd }}</strong>
      </div>
      <div>
        <span>Giá trị trung bình hóa đơn</span>
        <strong>{{ average_ticket|vnd }}</strong>
      </div>
    </div>
  </section>

  <section class="card stats-card">
    <header>
      <span class="stats-subtitle">Tháng {{ start_month.strftime('%m/%Y') }}</span>
      <h3>Kết quả gần nhất</h3>
    </header>
    <div class="stats-list">
      <div>
        <span>Đơn hoàn tất</span>
        <strong>{{ month_stats.tong_hoa_don }}</strong>
      </div>
      <div>
        <span>Doanh thu</span>
        <strong>{{ month_stats.tong_doanh_thu|vnd }}</strong>
      </div>
      <div>
        <span>Tiền phòng</span>
        <strong>{{ month_stats.tong_tien_phong|vnd }}</strong>
      </div>
      <div>
        <span>Dịch vụ &amp; phụ phí</span>
        <strong>{{ month_stats.tong_tien_dv|vnd }} • {{ month_stats.tong_tien_phat|vnd }}</strong>
      </div>
    </div>
  </section>

  <section class="card stats-card salary-card">
    <header>
      <span class="stats-subtitle">Lương & thưởng</span>
      <h3>Kỳ {{ start_month.strftime('%m/%Y') }}</h3>
    </header>
    <div class="stats-list salary-list">
      <div>
        <span>Lương cơ bản</span>
        <strong>{{ salary_info.luong_co_ban|vnd }}</strong>
        {% if salary_info.salary_mode == 'daily' %}
        <small>{{ salary_info.work_days }} ngày × {{ salary_info.daily_rate|vnd }} (chia {{ salary_info.daily_divisor }})</small>
        {% else %}
        <small>Giá trị tháng cố định</small>
        {% endif %}
      </div>
      <div>
        <span>Phụ cấp</span>
        <strong>{{ salary_info.phu_cap|vnd }}</strong>
        {% if salary_info.phu_cap == 0 and salary_info.work_days < salary_info.min_days %}
        <small style="color:#d9534f; display:block;">Chưa đạt chuyên cần ({{ salary_info.work_days }}/{{ salary_info.min_days }} ngày)</small>
        {% endif %}
      </div>
      <div>
        <span>Thưởng doanh thu</span>
        <strong>{{ salary_info.thuong_thang|vnd }}{% if salary_info.ty_le %} ({{ salary_info.ty_le|round(2) }}%) {% endif %}</strong>
      </div>
      {% if salary_info.top_bonus %}
      <div>
        <span>Thưởng top doanh thu</span>
        <strong>{{ salary_info.top_bonus|vnd }}</strong>
      </div>
      {% endif %}
      <div class="salary-total-row">
        <span>Tổng thu nhập tạm tính</span>
        <strong>{{ salary_info.tong|vnd }}</strong>
      </div>
    </div>
  </section>

  <section class="card stats-card">
    <header>
      <span class="stats-subtitle">Cơ cấu doanh thu</span>
      <h3>Tỷ trọng</h3>
    </header>
    <div class="ratio-list">
      <div class="ratio-item">
        <div class="ratio-bar">
          <span style="width: {{ service_ratio }}%"></span>
        </div>
        <div class="ratio-label">
          <strong>{{ service_ratio }}%</strong>
          <span>Dịch vụ / Tổng doanh thu</span>
        </div>
      </div>
      <div class="ratio-item">
        <div class="ratio-bar penalty">
          <span style="width: {{ penalty_ratio }}%"></span>
        </div>
        <div class="ratio-label">
          <strong>{{ penalty_ratio }}%</strong>
          <span>Phí phạt / Tổng doanh thu</span>
        </div>
      </div>
    </div>
    <p class="ratio-note">Tỷ lệ dựa trên các giao dịch đã hoàn tất.</p>
  </section>
</div>

<div class="card">
  <header class="section-heading">
    <h3>Doanh thu 6 tháng gần đây</h3>
  </header>
  <div class="trend-grid">
    {% for item in revenue_trend %}
      <div class="trend-item">
        <span class="trend-label">{{ item.label }}</span>
        <strong class="trend-value">{{ item.value|vnd }}</strong>
      </div>
    {% endfor %}
  </div>
</div>

<div class="detail-lists">
  <section class="card">
    <header class="section-heading">
      <h3>Đơn hàng đã xử lý gần đây</h3>
    </header>
    <div class="table-scroll">
      <table class="detail-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Phòng</th>
            <th>Khách hàng</th>
            <th>Nhận</th>
            <th>Trả</th>
            <th>Tổng thanh toán</th>
          </tr>
        </thead>
        <tbody>
          {% if recent_bookings %}
            {% for dp in recent_bookings %}
              <tr>
                <td>#{{ dp.id }}</td>
                <td>{{ dp.phong.ten }}</td>
                <td>{{ dp.khachhang.ho_ten }}</td>
                <td>{{ dp.thuc_te_nhan|fmt_dt if dp.thuc_te_nhan else dp.ngay_nhan|fmt_dt }}</td>
                <td>{{ dp.thuc_te_tra|fmt_dt if dp.thuc_te_tra else '—' }}</td>
                <td>{{ dp.tong_thanh_toan|vnd }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" style="text-align:center; padding: 24px; color:#6b8a7a;">Chưa có giao dịch nào được ghi nhận.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <header class="section-heading">
      <h3>Khách hàng thân thiết</h3>
    </header>
    <ul class="customer-list">
      {% if top_customers %}
        {% for c in top_customers %}
          <li>
            <div>
              <strong>{{ c.ten }}</strong>
              <span>{{ c.so_lan }} lượt lưu trú</span>
            </div>
            <span class="customer-spend">{{ c.tong_chi|vnd }}</span>
          </li>
        {% endfor %}
      {% else %}
        <li class="empty">Chưa có dữ liệu khách hàng thân thiết.</li>
      {% endif %}
    </ul>
  </section>
</div>

<style>
.back-link { display:inline-block; margin-bottom:16px; color:#2f7d5a; text-decoration:none; font-weight:600; }
.back-link:hover { text-decoration:underline; }
.staff-detail-header { display:flex; gap:28px; align-items:center; margin-bottom:24px; }
.detail-avatar img { width:140px; height:140px; border-radius:50%; object-fit:cover; border:6px solid rgba(47,125,90,0.15); background:#f8fbf9; }
.detail-main { flex:1; display:flex; flex-direction:column; gap:16px; }
.detail-title { display:flex; align-items:center; gap:12px; }
.detail-title h3 { margin:0; font-size:1.75em; color:#0b3d2a; }
.role-chip { padding:6px 14px; border-radius:999px; font-size:0.85em; font-weight:600; }
.chip-admin { background:rgba(208,76,58,0.12); color:#c0341e; }
.chip-staff { background:rgba(47,125,90,0.12); color:#1c5b45; }
.detail-meta { display:flex; gap:32px; margin:0; }
.detail-meta div { display:flex; flex-direction:column; gap:2px; }
.detail-meta dt { font-size:0.8em; text-transform:uppercase; letter-spacing:0.08em; color:#6b8a7a; }
.detail-meta dd { margin:0; font-weight:600; color:#1c5b45; }
.detail-highlight { display:flex; gap:32px; }
.detail-highlight .label { font-size:0.8em; color:#6b8a7a; }
.detail-highlight strong { font-size:1.4em; color:#0b3d2a; display:block; margin-top:4px; }

.stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:24px; margin-bottom:24px; }
.stats-card header { margin-bottom:18px; }
.stats-subtitle { font-size:0.8em; text-transform:uppercase; letter-spacing:0.1em; color:rgba(12,62,44,0.6); }
.stats-list, .ratio-list { display:grid; gap:12px; }
.salary-list { background: rgba(47,125,90,0.05); padding:12px; border-radius:12px; }
.salary-total-row { background: rgba(47,125,90,0.12); border-radius:10px; padding:12px; display:flex; justify-content:space-between; align-items:center; }

.stats-list div { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:12px; background:rgba(47,125,90,0.08); border:1px solid rgba(47,125,90,0.12); }
.stats-list span { color:#3f6c58; }
.stats-list strong { color:#0b3d2a; }
.ratio-item { display:flex; align-items:center; gap:14px; }
.ratio-bar { flex:1; height:10px; background:rgba(47,125,90,0.12); border-radius:999px; position:relative; }
.ratio-bar span { position:absolute; left:0; top:0; bottom:0; border-radius:999px; background:#2f7d5a; }
.ratio-bar.penalty { background:rgba(208,76,58,0.12); }
.ratio-bar.penalty span { background:#d04c3a; }
.ratio-label { display:flex; flex-direction:column; gap:2px; }
.ratio-label span { font-size:0.85em; color:#556f62; }
.ratio-note { margin-top:14px; font-size:0.85em; color:#6b8a7a; }

.trend-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px; }
.trend-item { padding:14px; border-radius:12px; border:1px solid rgba(47,125,90,0.12); background:#f6fbf8; text-align:center; }
.trend-label { font-size:0.85em; color:#3f6c58; }
.trend-value { display:block; margin-top:6px; font-size:1.1em; color:#0b3d2a; }

.detail-lists { display:grid; grid-template-columns: 1.4fr 0.6fr; gap:24px; margin-top:24px; }
.section-heading { margin-bottom:16px; }
.section-heading h3 { margin:0; color:#0b3d2a; }
.detail-table { width:100%; border-collapse:collapse; }
.detail-table th, .detail-table td { padding:12px 14px; border-bottom:1px solid #edf2ee; text-align:left; }
.detail-table th { background:#f4f8f5; color:#2f7d5a; font-weight:600; }
.customer-list { list-style:none; margin:0; padding:0; display:grid; gap:12px; }
.customer-list li { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-radius:12px; background:rgba(47,125,90,0.08); border:1px solid rgba(47,125,90,0.12); }
.customer-list li div { display:flex; flex-direction:column; gap:4px; }
.customer-list li span { color:#3f6c58; font-size:0.85em; }
.customer-spend { font-weight:600; color:#0b3d2a; }
.customer-list li.empty { justify-content:center; color:#6b8a7a; }

.permission-card { margin-bottom:24px; display:flex; flex-direction:column; gap:18px; }
.permission-header { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
.permission-header h3 { margin:0; color:#0b3d2a; }
.permission-header p { margin:4px 0 0; color:#56726a; font-size:0.92em; max-width:520px; }
.permission-badges { display:flex; gap:8px; flex-wrap:wrap; }
.permission-groups { display:flex; flex-direction:column; gap:18px; }
.permission-group h4 { margin:0 0 10px; font-size:1em; color:#14532d; }
.permission-items { display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
.permission-item { display:flex; justify-content:space-between; align-items:center; gap:16px; padding:14px 16px; border-radius:14px; border:1px solid rgba(34,197,94,0.18); background:#f5fbf7; transition:border-color 0.18s ease, background 0.18s ease; }
.permission-item.inherited:not(.personal) { background:#f8fafc; border-color:rgba(148,163,184,0.35); }
.permission-item.personal { background:#f0fdf4; border-color:rgba(34,197,94,0.45); box-shadow:0 10px 20px rgba(34,197,94,0.15); }
.permission-info { display:flex; flex-direction:column; gap:6px; flex:1; }
.permission-info strong { color:#065f46; font-size:0.98em; }
.permission-info .hint { font-size:0.82em; color:#6b8f7c; }
.permission-actions { display:flex; align-items:center; gap:10px; }
.badge { display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 12px; font-size:0.75em; font-weight:600; letter-spacing:0.04em; text-transform:uppercase; }
.badge-inherit { background:rgba(59,130,246,0.12); color:#1d4ed8; border:1px solid rgba(59,130,246,0.3); }
.badge-personal { background:rgba(34,197,94,0.12); color:#15803d; border:1px solid rgba(34,197,94,0.3); }
.action-inherit { display:none; }
.action-personal { display:none; }
.permission-item.inherited:not(.personal) .action-inherit { display:inline-flex; }
.permission-item.personal .action-personal { display:inline-flex; }
.permission-item.inherited:not(.personal) .switch { display:none; }

.switch { position:relative; display:inline-flex; width:44px; height:24px; }
.switch input { opacity:0; width:0; height:0; }
.slider { position:absolute; cursor:pointer; inset:0; background:#d1d5db; border-radius:999px; transition:all 0.2s ease; }
.slider:before { content:\"\"; position:absolute; height:20px; width:20px; left:2px; top:2px; background:white; border-radius:50%; transition:transform 0.2s ease; box-shadow:0 2px 6px rgba(15,23,42,0.2); }
.switch input:checked + .slider { background:linear-gradient(135deg,#16a34a,#22c55e); }
.switch input:checked + .slider:before { transform:translateX(20px); }
.switch input[data-locked=\"true\"] + .slider { background:linear-gradient(135deg,#16a34a,#22c55e); opacity:0.6; cursor:not-allowed; }
.switch input[data-locked=\"true\"] + .slider:before { transform:translateX(20px); box-shadow:none; }

@media (max-width: 1100px) {
  .staff-detail-header { flex-direction:column; align-items:flex-start; }
  .detail-highlight { flex-direction:column; }
  .detail-meta { flex-direction:column; gap:12px; }
  .detail-lists { grid-template-columns:1fr; }
}
</style>

<script>
(function() {
  const permissionCard = document.getElementById('user-permission-card');
  if (!permissionCard) { return; }

  const updateEndpoint = permissionCard.dataset.updateEndpoint;
  const successIcon = '<i class="fas fa-check-circle"></i>';
  const warningIcon = '<i class="fas fa-exclamation-triangle"></i>';
  const errorIcon = '<i class="fas fa-times-circle"></i>';
  const toast = typeof window.showToast === 'function' ? window.showToast : function() {};
  let isUpdating = false;

  function getToggles() {
    return Array.from(permissionCard.querySelectorAll('[data-user-permission-toggle]'));
  }

  function applyState(personalList) {
    const personalSet = new Set(personalList || []);
    permissionCard.dataset.personal = JSON.stringify(Array.from(personalSet));
    getToggles().forEach(input => {
      const item = input.closest('.permission-item');
      if (!item) { return; }
      const key = input.value;
      const isInherited = item.classList.contains('inherited');
      if (personalSet.has(key)) {
        item.classList.add('personal');
        input.checked = true;
        input.disabled = false;
        input.removeAttribute('data-locked');
      } else {
        item.classList.remove('personal');
        input.checked = false;
        if (isInherited) {
          input.setAttribute('data-locked', 'true');
          input.disabled = true;
        } else {
          input.removeAttribute('data-locked');
          input.disabled = false;
        }
      }
    });
  }

  function getPersonalFromDom() {
    const result = [];
    getToggles().forEach(input => {
      const item = input.closest('.permission-item');
      if (!item) { return; }
      const locked = input.dataset.locked === 'true';
      if (input.checked && !locked) {
        result.push(input.value);
      }
    });
    return result;
  }

  async function updatePermissions(personal) {
    const response = await fetch(updateEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ permissions: personal })
    });
    let data = null;
    try {
      data = await response.json();
    } catch (err) {
      throw new Error('Phản hồi không hợp lệ từ máy chủ.');
    }
    if (!response.ok || !data || data.status !== 'success') {
      throw new Error((data && data.message) || 'Không thể cập nhật quyền.');
    }
    applyState(data.personalPermissions || []);
    toast(successIcon, 'Thành công', data.message || 'Đã cập nhật quyền cá nhân.');
  }

  const initialPersonal = (() => {
    try {
      return JSON.parse(permissionCard.dataset.personal || '[]');
    } catch (err) {
      return [];
    }
  })();
  applyState(initialPersonal);

  getToggles().forEach(input => {
    const locked = input.dataset.locked === 'true';
    if (locked) {
      input.disabled = true;
      return;
    }
    input.addEventListener('change', event => {
      if (isUpdating) {
        event.preventDefault();
        event.stopPropagation();
        return;
      }
      const before = (() => {
        try { return JSON.parse(permissionCard.dataset.personal || '[]'); }
        catch (_err) { return []; }
      })();
      const next = getPersonalFromDom();
      isUpdating = true;
      updatePermissions(next).catch(err => {
        console.error(err);
        applyState(before);
        toast(errorIcon, 'Lỗi', err.message || 'Không thể cập nhật quyền.');
      }).finally(() => {
        isUpdating = false;
      });
    });
  });
})();
</script>

{% endblock %}
