{% extends 'base.html' %}
{% block content %}

<style>
  .customers-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
  }
  
  .customers-header h2 {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
    color: #1c5b45;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .customers-header .icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 18px;
    margin-bottom: 24px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #ffffff, #f8fafc);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 12px -4px rgba(15, 23, 42, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px -6px rgba(15, 23, 42, 0.15);
  }
  
  .stat-card .stat-icon {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-bottom: 12px;
  }
  
  .stat-card.total .stat-icon {
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    color: white;
  }
  
  .stat-card.active .stat-icon {
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    color: white;
  }
  
  .stat-card.locked .stat-icon {
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    color: white;
  }
  
  .stat-card .stat-label {
    font-size: 13px;
    color: #1c5b45;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
  }
  
  .stat-card .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1c5b45;
    line-height: 1;
  }
  
  .filter-card {
    background: white;
    border-radius: 18px;
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 16px -6px rgba(15, 23, 42, 0.1);
  }
  
  .filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
  }
  
  .filter-group {
    flex: 1;
    min-width: 240px;
  }
  
  .filter-group label {
    display: block;
    font-weight: 600;
    color: #1c5b45;
    margin-bottom: 8px;
    font-size: 14px;
  }
  
  .filter-group input,
  .filter-group select {
    width: 100%;
    padding: 12px 16px;
    border-radius: 10px;
    border: 1px solid #c8e6c9;
    background: #f1f8f4;
    font-size: 15px;
    transition: all 0.2s ease;
    font-family: inherit;
  }
  
  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: #2f7d5a;
    background: white;
    box-shadow: 0 0 0 3px rgba(47, 125, 90, 0.1);
  }
  
  .filter-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .filter-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px -8px rgba(47, 125, 90, 0.6);
  }
  
  .customers-table-card {
    background: white;
    border-radius: 18px;
    padding: 0;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 16px -6px rgba(15, 23, 42, 0.1);
    overflow: hidden;
  }
  
  .customers-table-card .table-scroll {
    overflow-x: auto;
  }
  
  .customers-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .customers-table thead {
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-bottom: 2px solid #e2e8f0;
  }
  
  .customers-table th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    color: #1c5b45;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .customers-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
  }
  
  .customers-table tbody tr:hover {
    background: #f8fafc;
  }
  
  .customers-table td {
    padding: 18px 20px;
    color: #334155;
    font-size: 14px;
  }
  
  .customer-name {
    font-weight: 600;
    color: #1c5b45;
  }
  
  .customer-email {
    color: #2f7d5a;
    text-decoration: none;
  }
  
  .customer-email:hover {
    text-decoration: underline;
  }
  
  .customer-points {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }
  
  .status-badge.active {
    background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
    color: #1c5b45;
  }
  
  .status-badge.locked {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
  }
  
  .status-badge i {
    font-size: 12px;
  }
  
  .actions-cell {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .action-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  .action-input {
    flex: 1;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    font-size: 13px;
    min-width: 180px;
  }
  
  .action-input:focus {
    outline: none;
    border-color: #2f7d5a;
    box-shadow: 0 0 0 3px rgba(47, 125, 90, 0.1);
  }
  
  .action-input.danger {
    border-color: #fecaca;
    background: #fef2f2;
  }
  
  .action-input.danger:focus {
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
  }
  
  .action-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .action-btn.unlock {
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    color: white;
  }
  
  .action-btn.unlock:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -4px rgba(47, 125, 90, 0.6);
  }
  
  .action-btn.lock {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
  }
  
  .action-btn.lock:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -4px rgba(245, 158, 11, 0.6);
  }
  
  .action-btn.delete {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
  }
  
  .action-btn.delete:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -4px rgba(220, 38, 38, 0.6);
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
  }
  
  .empty-state i {
    font-size: 64px;
    color: #cbd5e1;
    margin-bottom: 16px;
  }
  
  .empty-state p {
    font-size: 16px;
    margin: 0;
  }
  
  /* Pagination styles */
  .pagination-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 24px;
    gap: 12px;
  }
  
  .pagination {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  .pagination-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #64748b;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .pagination-btn:hover:not(.disabled):not(.active) {
    background: #f8fafc;
    border-color: #2f7d5a;
    color: #2f7d5a;
    transform: translateY(-1px);
  }
  
  .pagination-btn.active {
    background: linear-gradient(135deg, #2f7d5a, #1c5b45);
    border-color: #2f7d5a;
    color: white;
    box-shadow: 0 4px 12px -4px rgba(47, 125, 90, 0.4);
  }
  
  .pagination-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  .pagination-info {
    margin: 0 12px;
    font-size: 14px;
    color: #64748b;
  }
  
  @media (max-width: 768px) {
    .filter-form {
      flex-direction: column;
    }
    
    .filter-group {
      width: 100%;
    }
    
    .filter-btn {
      width: 100%;
      justify-content: center;
    }
    
    .pagination {
      flex-wrap: wrap;
    }
    
    .pagination-info {
      width: 100%;
      text-align: center;
      order: -1;
      margin-bottom: 12px;
    }
  }
</style>

<div class="customers-header">
  <div class="icon">
    <i class="fas fa-users"></i>
  </div>
  <h2>Quản lý tài khoản khách hàng</h2>
</div>

<div class="stats-grid">
  <div class="stat-card total">
    <div class="stat-icon">
      <i class="fas fa-users"></i>
    </div>
    <div class="stat-label">Tổng tài khoản</div>
    <div class="stat-value">{{ all_accounts|length }}</div>
  </div>
  
  <div class="stat-card active">
    <div class="stat-icon">
      <i class="fas fa-user-check"></i>
    </div>
    <div class="stat-label">Đang hoạt động</div>
    <div class="stat-value">{{ all_accounts|selectattr('trang_thai_tai_khoan', 'equalto', 'hoat_dong')|list|length }}</div>
  </div>
  
  <div class="stat-card locked">
    <div class="stat-icon">
      <i class="fas fa-user-lock"></i>
    </div>
    <div class="stat-label">Đã khóa</div>
    <div class="stat-value">{{ all_accounts|selectattr('trang_thai_tai_khoan', 'equalto', 'khoa')|list|length }}</div>
  </div>
</div>

<div class="filter-card">
  <form method="get" class="filter-form">
    <div class="filter-group">
      <label for="q">
        <i class="fas fa-search"></i> Tìm kiếm nhanh
      </label>
      <input 
        type="text" 
        id="q" 
        name="q" 
        value="{{ keyword }}" 
        placeholder="Nhập họ tên, CMND hoặc email..."
      >
    </div>
    
    <div class="filter-group" style="flex: 0 0 200px;">
      <label for="trang_thai">
        <i class="fas fa-filter"></i> Trạng thái
      </label>
      <select name="trang_thai" id="trang_thai">
        <option value="">Tất cả trạng thái</option>
        <option value="hoat_dong" {% if selected_status == 'hoat_dong' %}selected{% endif %}>Hoạt động</option>
        <option value="khoa" {% if selected_status == 'khoa' %}selected{% endif %}>Đã khóa</option>
      </select>
    </div>
    
    <button type="submit" class="filter-btn">
      <i class="fas fa-filter"></i>
      <span>Lọc danh sách</span>
    </button>
  </form>
</div>

<div class="customers-table-card">
  <div class="table-scroll">
    <table class="customers-table">
      <thead>
        <tr>
          <th style="width: 60px;">#</th>
          <th>Khách hàng</th>
          <th>CMND/CCCD</th>
          <th>Liên hệ</th>
          <th>Điểm tích lũy</th>
          <th>Trạng thái</th>
          <th>Đăng nhập cuối</th>
          <th style="min-width: 350px;">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        {% for kh in accounts %}
        <tr>
          <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
          <td>
            <div class="customer-name">{{ kh.ho_ten }}</div>
          </td>
          <td>
            <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 13px;">{{ kh.cmnd }}</code>
          </td>
          <td>
            {% if kh.email %}
              <a href="mailto:{{ kh.email }}" class="customer-email">
                <i class="fas fa-envelope"></i> {{ kh.email }}
              </a>
            {% else %}
              <span style="color: #94a3b8;">—</span>
            {% endif %}
            {% if kh.sdt %}
              <div style="margin-top: 4px; color: #64748b; font-size: 13px;">
                <i class="fas fa-phone"></i> {{ kh.sdt }}
              </div>
            {% endif %}
          </td>
          <td>
            <span class="customer-points">
              <i class="fas fa-star"></i>
              {{ kh.diem_tich_luy or 0 }}
            </span>
          </td>
          <td>
            {% if kh.trang_thai_tai_khoan == 'khoa' %}
              <span class="status-badge locked">
                <i class="fas fa-lock"></i>
                Đã khóa
              </span>
            {% else %}
              <span class="status-badge active">
                <i class="fas fa-check-circle"></i>
                Hoạt động
              </span>
            {% endif %}
          </td>
          <td style="color: #64748b; font-size: 13px;">
            {% if kh.lan_dang_nhap_cuoi %}
              <i class="fas fa-clock"></i> {{ kh.lan_dang_nhap_cuoi|fmt_dt }}
            {% else %}
              <i class="fas fa-info-circle"></i> Chưa đăng nhập
            {% endif %}
          </td>
          <td>
            <div class="actions-cell">
              <form method="post" action="{{ url_for('cap_nhat_trang_thai_khach_hang', kh_id=kh.id) }}" class="action-row">
                <input type="hidden" name="redirect_to" value="{{ request.full_path }}">
                {% if kh.trang_thai_tai_khoan == 'khoa' %}
                  <input type="hidden" name="trang_thai" value="hoat_dong">
                  <button type="submit" class="action-btn unlock">
                    <i class="fas fa-unlock"></i>
                    Mở khóa
                  </button>
                {% else %}
                  <input type="hidden" name="trang_thai" value="khoa">
                  <input 
                    type="text" 
                    name="ly_do" 
                    class="action-input" 
                    placeholder="Nhập lý do khóa..." 
                    required
                  >
                  <button type="submit" class="action-btn lock">
                    <i class="fas fa-lock"></i>
                    Khóa
                  </button>
                {% endif %}
              </form>
              
              {% if current_user.has_permission('customers.manage_accounts') %}
              <form method="post" action="{{ url_for('xoa_tai_khoan_khach_hang', kh_id=kh.id) }}" class="action-row">
                <input type="hidden" name="redirect_to" value="{{ request.full_path }}">
                <input 
                  type="text" 
                  name="ly_do_xoa" 
                  class="action-input danger" 
                  placeholder="Nhập lý do xóa..." 
                  required
                >
                <button 
                  type="submit" 
                  class="action-btn delete" 
                  onclick="return confirm('⚠️ Bạn có chắc muốn xóa vĩnh viễn tài khoản này?\n\nHành động này không thể hoàn tác!');"
                >
                  <i class="fas fa-trash-alt"></i>
                  Xóa
                </button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
        
        {% if not accounts %}
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <i class="fas fa-users-slash"></i>
              <p>Chưa có khách hàng nào đăng ký tài khoản</p>
            </div>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  
  {% if pagination.pages > 1 %}
  <div class="pagination-wrapper">
    <div class="pagination">
      <!-- Previous button -->
      {% if pagination.has_prev %}
        <a href="{{ url_for('quan_ly_tai_khoan_khach_hang', page=pagination.prev_num, q=keyword, trang_thai=selected_status) }}" class="pagination-btn">
          <i class="fas fa-chevron-left"></i>
        </a>
      {% else %}
        <span class="pagination-btn disabled">
          <i class="fas fa-chevron-left"></i>
        </span>
      {% endif %}
      
      <!-- Page numbers -->
      {% set start_page = [1, pagination.page - 2]|max %}
      {% set end_page = [pagination.pages, pagination.page + 2]|min %}
      
      {% if start_page > 1 %}
        <a href="{{ url_for('quan_ly_tai_khoan_khach_hang', page=1, q=keyword, trang_thai=selected_status) }}" class="pagination-btn">1</a>
        {% if start_page > 2 %}
          <span class="pagination-btn disabled">...</span>
        {% endif %}
      {% endif %}
      
      {% for page_num in range(start_page, end_page + 1) %}
        {% if page_num == pagination.page %}
          <span class="pagination-btn active">{{ page_num }}</span>
        {% else %}
          <a href="{{ url_for('quan_ly_tai_khoan_khach_hang', page=page_num, q=keyword, trang_thai=selected_status) }}" class="pagination-btn">{{ page_num }}</a>
        {% endif %}
      {% endfor %}
      
      {% if end_page < pagination.pages %}
        {% if end_page < pagination.pages - 1 %}
          <span class="pagination-btn disabled">...</span>
        {% endif %}
        <a href="{{ url_for('quan_ly_tai_khoan_khach_hang', page=pagination.pages, q=keyword, trang_thai=selected_status) }}" class="pagination-btn">{{ pagination.pages }}</a>
      {% endif %}
      
      <!-- Next button -->
      {% if pagination.has_next %}
        <a href="{{ url_for('quan_ly_tai_khoan_khach_hang', page=pagination.next_num, q=keyword, trang_thai=selected_status) }}" class="pagination-btn">
          <i class="fas fa-chevron-right"></i>
        </a>
      {% else %}
        <span class="pagination-btn disabled">
          <i class="fas fa-chevron-right"></i>
        </span>
      {% endif %}
    </div>
    
    <div class="pagination-info">
      Hiển thị {{ (pagination.page - 1) * pagination.per_page + 1 }} - {{ [(pagination.page * pagination.per_page), pagination.total]|min }} / {{ pagination.total }} khách hàng
    </div>
  </div>
  {% endif %}
</div>

{% endblock %}
