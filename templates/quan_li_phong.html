{% extends 'base.html' %}

{% block content %}
{% set total_rooms = rooms_payload|length %}
{% set available_rooms = rooms_payload|selectattr('trang_thai', 'equalto', 'trong')|list|length %}
{% set booked_rooms = rooms_payload|selectattr('trang_thai', 'equalto', 'da_dat')|list|length %}
{% set occupied_rooms = rooms_payload|selectattr('trang_thai', 'equalto', 'dang_o')|list|length %}
{% set overdue_rooms = rooms_payload|selectattr('trang_thai', 'equalto', 'qua_gio')|list|length %}
{% set status_labels = {
  'trong': 'Phòng trống',
  'da_dat': 'Đã đặt',
  'dang_o': 'Đang ở',
  'qua_gio': 'Quá giờ'
} %}

<section class="room-page">
  <header class="room-page__header">
    <div class="room-page__title">
      <h1>Quản lý phòng</h1>
      <p>Theo dõi trạng thái từng phòng và cập nhật thông tin trong tích tắc.</p>
    </div>
    <div class="room-page__actions">
      <a class="button secondary" href="{{ url_for('quan_li_loai_phong') }}">
        <i class="fas fa-layer-group"></i>
        <span>Quản lý loại phòng</span>
      </a>
      <a class="button primary" href="#room-form">
        <i class="fas fa-plus-circle"></i>
        <span>Thêm phòng</span>
      </a>
      {% if phong_edit %}
      <a class="button ghost" href="{{ url_for('quan_li_phong') }}">
        <i class="fas fa-times"></i>
        <span>Hủy chỉnh sửa</span>
      </a>
      {% endif %}
    </div>
  </header>

  <section class="room-stats">
    <button type="button" class="room-stat room-stat--total is-active" data-filter-status="all">
      <span class="room-stat__icon"><i class="fas fa-hotel"></i></span>
      <span class="room-stat__content">
        <span class="room-stat__label">Tổng số phòng</span>
        <span class="room-stat__value">{{ total_rooms }}</span>
      </span>
    </button>
    <button type="button" class="room-stat room-stat--available" data-filter-status="trong">
      <span class="room-stat__icon"><i class="fas fa-door-open"></i></span>
      <span class="room-stat__content">
        <span class="room-stat__label">Phòng trống</span>
        <span class="room-stat__value">{{ available_rooms }}</span>
      </span>
    </button>
    <button type="button" class="room-stat room-stat--booked" data-filter-status="da_dat">
      <span class="room-stat__icon"><i class="fas fa-calendar-check"></i></span>
      <span class="room-stat__content">
        <span class="room-stat__label">Đã đặt</span>
        <span class="room-stat__value">{{ booked_rooms }}</span>
      </span>
    </button>
    <button type="button" class="room-stat room-stat--occupied" data-filter-status="dang_o">
      <span class="room-stat__icon"><i class="fas fa-user-check"></i></span>
      <span class="room-stat__content">
        <span class="room-stat__label">Đang ở</span>
        <span class="room-stat__value">{{ occupied_rooms }}</span>
      </span>
    </button>
    <button type="button" class="room-stat room-stat--overdue" data-filter-status="qua_gio">
      <span class="room-stat__icon"><i class="fas fa-clock"></i></span>
      <span class="room-stat__content">
        <span class="room-stat__label">Quá giờ / chờ</span>
        <span class="room-stat__value">{{ overdue_rooms }}</span>
      </span>
    </button>
  </section>

  <div class="room-layout">
    <section class="room-list">
      <div class="room-filters">
        <div class="filter-search">
          <i class="fas fa-search"></i>
          <input id="room-search" type="search" placeholder="Tìm theo số phòng, loại phòng hoặc trạng thái...">
          <button id="room-search-clear" type="button" aria-label="Xóa tìm kiếm">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="room-list__meta">
        <span id="room-count-indicator">
          <i class="fas fa-info-circle"></i>
          Đang hiển thị {{ total_rooms }} / {{ total_rooms }} phòng
        </span>
      </div>

      <div class="room-grid" id="room-grid">
        {% if phongs %}
        {% for phong in phongs %}
        {% set active_booking = room_booking_status.get(phong.id) %}
        <article class="room-card status-{{ phong.trang_thai }}"
          data-status="{{ phong.trang_thai }}"
          data-type="{{ phong.loai_id }}"
          data-search="{{ (phong.ten ~ ' ' ~ (phong.loai.ten if phong.loai else '') ~ ' ' ~ status_labels.get(phong.trang_thai, phong.trang_thai))|lower }}">
          <div class="room-card__top">
            <span class="room-card__badge">
              {{ status_labels.get(phong.trang_thai, phong.trang_thai) }}
            </span>
            <div class="room-card__actions">
              <a class="icon-button" href="{{ url_for('sua_phong', phong_id=phong.id) }}" title="Chỉnh sửa phòng">
                <i class="fas fa-pen-to-square"></i>
              </a>
              <form class="inline-form room-delete-form" action="{{ url_for('xoa_phong', phong_id=phong.id) }}" method="post">
                <button class="icon-button danger" type="submit" title="Xóa phòng">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </div>
          </div>
          <div class="room-card__body">
            <h3 class="room-card__title">{{ phong.ten }}</h3>
            <dl class="room-card__info">
              <div>
                <dt><i class="fas fa-bed"></i> Loại phòng</dt>
                <dd>{{ phong.loai.ten if phong.loai else 'Chưa xác định' }}</dd>
              </div>
              <div>
                <dt><i class="fas fa-users"></i> Sức chứa</dt>
                <dd>
                  {% if phong.loai and phong.loai.so_nguoi_toi_da %}
                    {{ phong.loai.so_nguoi_toi_da }} khách
                  {% else %}
                    Đang cập nhật
                  {% endif %}
                </dd>
              </div>
              <div>
                <dt><i class="fas fa-money-bill-wave"></i> Giá niêm yết</dt>
                <dd>
                  {% if phong.loai and phong.loai.gia is not none %}
                    {{ "{:,}".format(phong.loai.gia|int) }} VNĐ / đêm
                  {% else %}
                    Đang cập nhật
                  {% endif %}
                </dd>
              </div>
            </dl>
          </div>
          {% if active_booking %}
          <footer class="room-card__footer">
            <span class="room-card__footer-label">
              <i class="fas fa-user-clock"></i> Đang giữ chỗ
            </span>
            <span class="room-card__footer-detail">
              {{ active_booking.khachhang.ho_ten if active_booking.khachhang else 'Khách lẻ' }}
              {% if active_booking.ngay_nhan %} · Nhận {{ active_booking.ngay_nhan.strftime('%d/%m %H:%M') }}{% endif %}
              {% if active_booking.ngay_tra %} · Trả {{ active_booking.ngay_tra.strftime('%d/%m %H:%M') }}{% endif %}
            </span>
          </footer>
          {% else %}
          <footer class="room-card__footer room-card__footer--idle">
            <i class="fas fa-circle-check"></i>
            <span>Không có đặt phòng trùng</span>
          </footer>
          {% endif %}
        </article>
        {% endfor %}
        {% else %}
        <div class="room-empty">
          <i class="fas fa-door-open"></i>
          <p>Chưa có phòng nào trong hệ thống. Hãy dùng biểu mẫu bên phải để thêm phòng mới.</p>
        </div>
        {% endif %}
      </div>
    </section>

    <aside class="room-form-panel" id="room-form">
      <header class="room-form-panel__header">
        {% if phong_edit %}
        <div class="room-form-panel__icon">
          <i class="fas fa-pen-to-square"></i>
        </div>
        <div>
          <h2>Cập nhật phòng</h2>
          <p>Điều chỉnh thông tin phòng và lưu để áp dụng ngay.</p>
        </div>
        {% else %}
        <div class="room-form-panel__icon">
          <i class="fas fa-plus-circle"></i>
        </div>
        <div>
          <h2>Thêm phòng mới</h2>
          <p>Nhập số phòng và chọn loại phòng tương ứng.</p>
        </div>
        {% endif %}
      </header>

      <form class="room-form" method="post" action="{% if phong_edit %}{{ url_for('sua_phong', phong_id=phong_edit.id) }}{% else %}{{ url_for('them_phong') }}{% endif %}">
        <div class="form-field">
          <label for="room-number"><i class="fas fa-door-closed"></i> Số phòng</label>
          <input id="room-number" name="so_phong" type="text" placeholder="Ví dụ: 1205" value="{{ phong_edit.ten if phong_edit else '' }}" required>
        </div>
        <div class="form-field">
          <label for="room-type"><i class="fas fa-bed"></i> Loại phòng</label>
          <select id="room-type" name="loai_id" required>
            <option value="">Chọn loại phòng</option>
            {% for loai in loai_phongs %}
            <option value="{{ loai.id }}" {% if phong_edit and phong_edit.loai_id == loai.id %}selected{% endif %}>
              {{ loai.ten }}{% if loai.gia is not none %} · {{ "{:,}".format(loai.gia|int) }} VNĐ{% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label for="room-status"><i class="fas fa-signal"></i> Trạng thái</label>
          <select id="room-status" name="trang_thai">
            <option value="trong" {% if not phong_edit or phong_edit.trang_thai == 'trong' %}selected{% endif %}>Phòng trống</option>
            <option value="da_dat" {% if phong_edit and phong_edit.trang_thai == 'da_dat' %}selected{% endif %}>Đã đặt</option>
            <option value="dang_o" {% if phong_edit and phong_edit.trang_thai == 'dang_o' %}selected{% endif %}>Đang ở</option>
            <option value="qua_gio" {% if phong_edit and phong_edit.trang_thai == 'qua_gio' %}selected{% endif %}>Quá giờ / Chờ check-in</option>
          </select>
        </div>
        <div class="form-actions">
          <button class="button primary wide" type="submit">
            {% if phong_edit %}
            <i class="fas fa-save"></i> Lưu thay đổi
            {% else %}
            <i class="fas fa-plus"></i> Thêm phòng
            {% endif %}
          </button>
          {% if phong_edit %}
          <a class="button ghost wide" href="{{ url_for('quan_li_phong') }}">
            <i class="fas fa-undo"></i> Hủy
          </a>
          {% endif %}
        </div>
      </form>

      <section class="room-form__note">
        <h3><i class="fas fa-lightbulb"></i> Mẹo sử dụng</h3>
        <ul>
          <li>Trạng thái <strong>Quá giờ</strong> giúp cảnh báo các booking tới muộn.</li>
          <li>Loại phòng quyết định giá hiển thị và sức chứa tối đa.</li>
          <li>Không thể xóa phòng đang có booking hoạt động.</li>
        </ul>
      </section>
    </aside>
  </div>
</section>

<style>
  .room-page {
    display: flex;
    flex-direction: column;
    gap: 28px;
    padding-bottom: 32px;
  }

  .room-page__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    background: #ffffff;
    border-radius: 22px;
    padding: 28px 32px;
    border: 1px solid rgba(148, 163, 184, 0.16);
    box-shadow: 0 18px 40px -30px rgba(15, 23, 42, 0.35);
  }

  .room-page__title h1 {
    margin: 0;
    font-size: 30px;
    font-weight: 700;
    color: #0f172a;
  }

  .room-page__title p {
    margin: 6px 0 0;
    color: #475569;
  }

  .room-page__actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border-radius: 12px;
    border: 1px solid transparent;
    font-weight: 600;
    font-size: 15px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .button.primary {
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: #ffffff;
  }

  .button.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 24px -16px rgba(15, 118, 110, 0.6);
  }

  .button.secondary {
    background: #ffffff;
    color: #0f766e;
    border-color: rgba(15, 118, 110, 0.35);
  }

  .button.secondary:hover {
    background: rgba(15, 118, 110, 0.08);
  }

  .button.ghost {
    background: transparent;
    color: #475569;
    border-color: rgba(148, 163, 184, 0.4);
  }

  .button.ghost:hover {
    background: rgba(148, 163, 184, 0.12);
  }

  .button.wide {
    justify-content: center;
    width: 100%;
  }

  .room-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 18px;
  }

  .room-stat {
    background: #ffffff;
    border-radius: 18px;
    padding: 18px 20px;
    border: 1px solid rgba(148, 163, 184, 0.16);
    box-shadow: 0 16px 35px -28px rgba(15, 23, 42, 0.4);
    display: flex;
    align-items: center;
    gap: 16px;
    font: inherit;
    color: inherit;
    width: 100%;
    cursor: pointer;
    text-align: left;
    transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    position: relative;
    outline: none;
    appearance: none;
  }

  .room-stat:hover:not(.is-active) {
    transform: translateY(-2px);
    box-shadow: 0 20px 40px -28px rgba(15, 23, 42, 0.54);
  }

  .room-stat:focus-visible {
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
  }

  .room-stat.is-active {
    border-color: rgba(34, 197, 94, 0.6);
    box-shadow: 0 24px 45px -26px rgba(22, 163, 74, 0.55);
  }

  .room-stat__icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(15, 118, 110, 0.12);
    color: #0f766e;
    font-size: 22px;
  }

  .room-stat--available .room-stat__icon {
    background: rgba(46, 125, 50, 0.15);
    color: #1b5e20;
  }

  .room-stat--booked .room-stat__icon {
    background: rgba(29, 78, 216, 0.12);
    color: #1d4ed8;
  }

  .room-stat--occupied .room-stat__icon {
    background: rgba(217, 119, 6, 0.14);
    color: #b45309;
  }

  .room-stat--overdue .room-stat__icon {
    background: rgba(220, 38, 38, 0.14);
    color: #b91c1c;
  }

  .room-stat__content {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .room-stat__label {
    font-size: 13px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }

  .room-stat__value {
    font-size: 28px;
    font-weight: 700;
    color: #0f172a;
    line-height: 1;
  }

  .room-stat--available {
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  }

  .room-stat--booked {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  }

  .room-stat--occupied {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
  }

  .room-stat--overdue {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
  }

  .room-layout {
    display: grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
    gap: 28px;
    align-items: start;
  }

  .room-list {
    background: #ffffff;
    border-radius: 22px;
    border: 1px solid rgba(148, 163, 184, 0.14);
    padding: 26px;
    box-shadow: 0 18px 45px -34px rgba(15, 23, 42, 0.4);
  }

  .room-filters {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .filter-search {
    position: relative;
    display: flex;
    align-items: center;
    border: 2px solid #0f766e;
    border-radius: 16px;
    background: #ffffff;
    padding: 0 16px;
    height: 52px;
    gap: 12px;
    box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.12);
  }

  .filter-search i {
    color: #0f766e;
    font-size: 18px;
  }

  .filter-search input {
    flex: 1;
    border: none;
    background: #ffffff;
    padding: 0;
    font-size: 16px;
    outline: none;
    color: #0f172a !important;
    -webkit-text-fill-color: #0f172a !important;
    caret-color: #0f172a;
  }

  .filter-search input::placeholder {
    color: #94a3b8;
    opacity: 1;
  }

  .filter-search button {
    border: none;
    background: rgba(15, 118, 110, 0.1);
    color: #0f766e;
    cursor: pointer;
    display: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  .filter-search button:hover {
    background: rgba(15, 118, 110, 0.16);
  }

  input[type="search"]::-webkit-search-decoration,
  input[type="search"]::-webkit-search-cancel-button,
  input[type="search"]::-webkit-search-results-button,
  input[type="search"]::-webkit-search-results-decoration {
    display: none;
  }

  .room-list__meta {
    margin: 18px 0;
    color: #64748b;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .room-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .room-card {
    border-radius: 20px;
    border: 1px solid rgba(148, 163, 184, 0.12);
    box-shadow: 0 16px 40px -34px rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background: #ffffff;
  }

  .room-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 60px -34px rgba(20, 184, 166, 0.5);
    border-color: rgba(20, 184, 166, 0.3);
  }

  .room-card__top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 20px 0;
  }

  .room-card__badge {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    border-radius: 999px;
    padding: 6px 12px;
    background: #f1f5f9;
    color: #0f172a;
  }

  .status-trong .room-card__badge {
    background: rgba(16, 185, 129, 0.15);
    color: #0f766e;
  }

  .status-da_dat .room-card__badge {
    background: rgba(59, 130, 246, 0.15);
    color: #2563eb;
  }

  .status-dang_o .room-card__badge {
    background: rgba(234, 179, 8, 0.2);
    color: #b45309;
  }

  .status-qua_gio .room-card__badge {
    background: rgba(239, 68, 68, 0.2);
    color: #b91c1c;
  }

  .room-card__actions {
    display: flex;
    gap: 8px;
  }

  .icon-button {
    border: none;
    background: rgba(148, 163, 184, 0.16);
    color: #475569;
    width: 34px;
    height: 34px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .icon-button:hover {
    background: rgba(20, 184, 166, 0.15);
    color: #0f766e;
  }

  .icon-button.danger:hover {
    background: rgba(239, 68, 68, 0.18);
    color: #b91c1c;
  }

  .room-card__body {
    padding: 14px 20px 0;
    flex: 1;
  }

  .room-card__title {
    margin: 0 0 14px;
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .room-card__info {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  .room-card__info dt {
    font-size: 12px;
    text-transform: uppercase;
    color: #64748b;
    letter-spacing: 0.5px;
    font-weight: 600;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .room-card__info dd {
    margin: 4px 0 0;
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
  }

  .room-card__footer {
    padding: 16px 20px 20px;
    border-top: 1px solid rgba(15, 118, 110, 0.12);
    background: rgba(15, 118, 110, 0.06);
    display: flex;
    flex-direction: column;
    gap: 6px;
    color: #0f172a;
  }

  .room-card__footer--idle {
    background: rgba(241, 245, 249, 0.7);
    border-top-color: rgba(203, 213, 225, 0.6);
    color: #475569;
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  .room-form-panel {
    background: #ffffff;
    border-radius: 22px;
    border: 1px solid rgba(148, 163, 184, 0.14);
    padding: 26px;
    box-shadow: 0 18px 45px -32px rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
    gap: 22px;
    position: sticky;
    top: 32px;
  }

  .room-form-panel__header {
    display: flex;
    align-items: center;
    gap: 14px;
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 16px;
  }

  .room-form-panel__icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: linear-gradient(135deg, #0f766e, #14b8a6);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .room-form-panel__header h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #0f172a;
  }

  .room-form-panel__header p {
    margin: 6px 0 0;
    color: #64748b;
  }

  .room-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-field label {
    font-weight: 600;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-field input,
  .form-field select {
    border: 1px solid #d0d7e5;
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 15px;
    background: #f8fafc;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-field input:focus,
  .form-field select:focus {
    outline: none;
    border-color: #0f766e;
    box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.14);
    background: #ffffff;
  }

  .form-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 6px;
  }

  .room-form__note {
    background: linear-gradient(135deg, rgba(15, 118, 110, 0.08), rgba(20, 184, 166, 0.14));
    border-radius: 18px;
    padding: 18px;
    border: 1px solid rgba(15, 118, 110, 0.2);
  }

  .room-form__note h3 {
    margin: 0 0 10px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #0f766e;
  }

  .room-form__note ul {
    margin: 0;
    padding-left: 20px;
    display: grid;
    gap: 6px;
    color: #334155;
  }

  .room-empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px 20px;
    border: 2px dashed rgba(148, 163, 184, 0.3);
    border-radius: 18px;
    color: #64748b;
    background: #ffffff;
  }

  .room-empty i {
    font-size: 36px;
    margin-bottom: 12px;
    color: #14b8a6;
  }

  @media (max-width: 1100px) {
    .room-layout {
      grid-template-columns: 1fr;
    }

    .room-form-panel {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .room-page__header {
      flex-direction: column;
      align-items: flex-start;
    }

    .room-grid {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('room-search');
    const clearButton = document.getElementById('room-search-clear');
    const countIndicator = document.getElementById('room-count-indicator');
    const roomCards = Array.from(document.querySelectorAll('.room-card'));
    const statFilters = Array.from(document.querySelectorAll('.room-stat[data-filter-status]'));
    let activeStatusFilter = 'all';

    function normalize(value) {
      if (!value) { return ''; }
      try {
        return value.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      } catch (err) {
        return value.toLowerCase();
      }
    }

    function applyFilters() {
      const keyword = normalize(searchInput ? searchInput.value.trim() : '');
      let visible = 0;

      roomCards.forEach(card => {
        const searchData = card.dataset.search || '';
        const matchesKeyword = !keyword || normalize(searchData).includes(keyword);
        const matchesStatus = activeStatusFilter === 'all' || card.dataset.status === activeStatusFilter;
        const shouldShow = matchesKeyword && matchesStatus;
        card.style.display = shouldShow ? '' : 'none';
        if (shouldShow) { visible += 1; }
      });

      if (countIndicator) {
        countIndicator.innerHTML = `<i class="fas fa-info-circle"></i> Đang hiển thị ${visible} / ${roomCards.length} phòng`;
      }

      if (clearButton) {
        clearButton.style.display = keyword ? 'inline-flex' : 'none';
      }
    }

    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }

    if (clearButton) {
      clearButton.addEventListener('click', function () {
        searchInput.value = '';
        applyFilters();
        searchInput.focus();
      });
    }

    function setStatusFilter(status, trigger) {
      activeStatusFilter = status;
      statFilters.forEach(button => {
        button.classList.toggle('is-active', button === trigger);
      });
      applyFilters();
    }

    statFilters.forEach(button => {
      button.addEventListener('click', () => {
        const status = button.dataset.filterStatus || 'all';
        if (status === activeStatusFilter) {
          activeStatusFilter = 'all';
          statFilters.forEach(btn => btn.classList.toggle('is-active', btn.dataset.filterStatus === 'all'));
          applyFilters();
        } else {
          setStatusFilter(status, button);
        }
      });
    });

    // Ensure default active (all) button highlighted
    const defaultFilter = statFilters.find(btn => btn.dataset.filterStatus === 'all');
    if (defaultFilter) {
      setStatusFilter('all', defaultFilter);
    } else {
      applyFilters();
    }

    document.querySelectorAll('.room-delete-form').forEach(form => {
      form.addEventListener('submit', function (event) {
        const roomName = this.closest('.room-card')?.querySelector('.room-card__title')?.textContent?.trim() || 'phòng';
        if (!confirm(`Bạn có chắc chắn muốn xóa ${roomName}?`)) {
          event.preventDefault();
        }
      });
    });
  });
</script>
{% endblock %}
