{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='salary.css') }}">

<div class="salary-management">
  <!-- PAGE HEADER -->
  <div class="salary-page-header">
    <div class="header-content">
      <h2><i class="fas fa-money-bill-wave"></i> Cài đặt Lương & Thưởng</h2>
      <p class="header-subtitle">Quản lý lương cơ bản, phụ cấp và mức thưởng theo doanh thu</p>
    </div>
  </div>

  <!-- STATISTICS CARDS -->
  {% include 'partials/salary_stats_grid.html' %}

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <span class="filter-label"><i class="fas fa-search"></i> Lọc nhân viên:</span>
    <form method="get" style="display: flex; gap: 12px; flex: 1;">
      <select name="staff_id" class="filter-select" onchange="this.form.submit()">
        <option value="">Tất cả nhân viên ({{ all_staffs|length }})</option>
        {% for staff in all_staffs %}
        <option value="{{ staff.id }}" {% if selected_id == staff.id %}selected{% endif %}>
          {{ staff.ten }} - {{ staff.ten_dang_nhap }}
        </option>
        {% endfor %}
      </select>
      {% if selected_id %}
      <a href="{{ url_for('cai_dat_luong_thuong') }}" class="btn-reset">
        <span><i class="fas fa-undo"></i></span> Reset
      </a>
      {% endif %}
    </form>
  </div>

  <!-- CONTENT GRID -->
  <div class="content-grid">
    <!-- LEFT: EMPLOYEE SALARY -->
    <div class="section-panel">
      <div class="panel-header">
        <div class="panel-subtitle">Nhân viên</div>
        <h3 class="panel-title">Lương cơ bản & Phụ cấp</h3>
        <p class="panel-description">
          Nhân viên dẫn đầu doanh thu tháng sẽ nhận thêm <strong>{{ bonus_amount|vnd }}</strong> thưởng top.
        </p>
      </div>

      {% include 'partials/salary_employee_list.html' %}
    </div>

    <!-- RIGHT: BONUS TIERS -->
    <div class="section-panel">
      <div class="panel-header">
        <div class="panel-subtitle">Bảng thưởng</div>
        <h3 class="panel-title">Mức thưởng theo Doanh thu</h3>
        <p class="panel-description">
          Áp dụng cho tổng doanh thu đã hoàn tất trong tháng. Để không giới hạn trên, để trống "Đến mức".
        </p>
      </div>

      {% include 'partials/salary_tier_list.html' %}
    </div>
  </div>
</div>

<script>
(function () {
  const ICONS = {
    success: '<i class="fas fa-check-circle"></i>',
    danger: '<i class="fas fa-times-circle"></i>',
    warning: '<i class="fas fa-exclamation-triangle"></i>',
    info: '<i class="fas fa-info-circle"></i>',
  };

  function notify(message, status) {
    if (!message) return;
    const level = status && ICONS[status] ? status : 'success';
    const icon = ICONS[level] || ICONS.success;
    if (typeof showToast === 'function') {
      showToast(icon, 'Cài đặt Lương & Thưởng', message);
    } else {
      console.log(`[${level}] ${message}`);
    }
  }

  function htmlToElement(html) {
    if (!html) return null;
    const template = document.createElement('template');
    template.innerHTML = html.trim();
    return template.content.firstElementChild;
  }

  function replaceSection(selector, html) {
    if (!html) return;
    const target = document.querySelector(selector);
    const replacement = htmlToElement(html);
    if (target && replacement) {
      target.replaceWith(replacement);
    }
  }

  async function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.currentTarget;
    const submitter = event.submitter || form.querySelector('button[type="submit"], input[type="submit"]');
    const formData = new FormData(form);
    if (submitter && submitter.name && !formData.has(submitter.name)) {
      formData.append(submitter.name, submitter.value);
    }
    if (submitter) submitter.disabled = true;
    try {
      const response = await fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        notify(data.message || 'Có lỗi xảy ra, vui lòng thử lại.', data.status || 'danger');
        return;
      }
      replaceSection('.stats-grid', data.stats_html);
      replaceSection('.employee-list', data.employees_html);
      replaceSection('.tier-list', data.tiers_html);
      bindForms();
      notify(data.message || 'Đã cập nhật thành công.', data.status || 'success');
    } catch (error) {
      console.error(error);
      notify('Có lỗi xảy ra, vui lòng thử lại.', 'danger');
    } finally {
      if (submitter) submitter.disabled = false;
    }
  }

  function bindForms() {
    const selectors = [
      '.config-form',
      '.employee-salary-card',
      '.tier-card form',
      '.tier-card.add-new form'
    ];
    document.querySelectorAll(selectors.join(',')).forEach(form => {
      if (form.dataset.boundSalary === '1') return;
      form.addEventListener('submit', handleFormSubmit);
      form.dataset.boundSalary = '1';
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    bindForms();
  });
})();
</script>

{% endblock %}
