<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản Lí Khách Sạn</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    // Fallback for FontAwesome
    if (typeof window.fa === 'undefined') {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '{{ url_for('static', filename='lib/font-awesome/css/all.min.css') }}';
      document.head.appendChild(link);
    }
  </script>
  <!-- NÂNG CẤP: Thêm thư viện FullCalendar cho trang Lịch Đặt Phòng -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

  <!-- CSS cho hệ thống thông báo "toast" -->
  <style>
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #2f7d5a;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 9999;
      transform: translateX(120%);
      transition: transform 0.5s ease-in-out;
    }
    .toast-notification.show {
      transform: translateX(0);
    }
    .toast-icon {
      font-size: 24px;
    }
    .toast-body h4 {
      margin: 0 0 5px;
    }
    .toast-body p {
      margin: 0;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <aside class="leftmenu">
    <div class="menu-header">
      <div class="logo-container">
        <a href="{{ url_for('dashboard') }}" class="brand-logo">
          <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Hotel Logo">
        </a>
      </div>
    </div>

    <nav class="menu-links">
      {% if current_user.is_authenticated %}
      
      <!-- TỔNG QUAN -->
      <div class="menu-group">
        <div class="menu-group-title">Tổng quan</div>
        <a href="{{ url_for('dashboard') }}" title="Bảng điều khiển"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span class="menu-text">Bảng điều khiển</span></a>
        <a href="{{ url_for('attendance_checkin') }}" title="Chấm công"><i class="fas fa-calendar-check"></i><span class="menu-text">Chấm công</span></a>
        {% if current_user.loai == 'admin' %}
        <a href="{{ url_for('attendance_admin') }}" title="Phê duyệt chấm công"><i class="fas fa-user-check"></i><span class="menu-text">Phê duyệt chấm công</span></a>
        {% endif %}
      </div>

      <!-- QUẢN LÝ PHÒNG -->
      <div class="menu-group">
        <div class="menu-group-title">Quản lý Phòng</div>
        <a href="{{ url_for('so_do_phong') }}" title="Sơ đồ phòng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M12.5 3H18v5.5"/><path d="M3 11.5V15l4 4h3.5"/><path d="M21 12.5V9l-4-4h-3.5"/></svg><span class="menu-text">Sơ đồ phòng</span></a>
        <a href="{{ url_for('dat_phong') }}" title="Đặt phòng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span class="menu-text">Đặt phòng</span></a>
        <a href="{{ url_for('quan_ly_dat_phong_online') }}" title="Đặt phòng online"{% if pending_online_count %} class="menu-link-with-badge"{% endif %}>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h18"></path><path d="M8 4v16"></path><path d="M16 4v16"></path><rect x="3" y="8" width="18" height="12" rx="2"></rect></svg>
          <span class="menu-text">Đặt phòng online</span>
          {% if pending_online_count %}
          <span class="menu-badge">{{ pending_online_count }}</span>
          {% endif %}
        </a>

        <a href="{{ url_for('nhan_phong') }}" title="Nhận & Trả phòng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg><span class="menu-text">Nhận & Trả phòng</span></a>
        <a href="{{ url_for('quan_ly_booking_cho') }}" title="Quản lý Booking chờ"><i class="fas fa-clock"></i><span class="menu-text">Booking chờ</span></a>
      </div>

      <!-- KHÁCH HÀNG & LIÊN LẠC -->
      <div class="menu-group">
        <div class="menu-group-title">Khách hàng</div>
        <a href="{{ url_for('tin_nhan') }}" title="Tin nhắn"{% if unread_messages and unread_messages > 0 %} class="menu-link-with-badge"{% endif %}>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          <span class="menu-text">Tin nhắn</span>
          {% if unread_messages and unread_messages > 0 %}
          <span class="notification-badge">{{ unread_messages if unread_messages < 100 else '99+' }}</span>
          {% endif %}
        </a>
        <a href="{{ url_for('khach_hang') }}" title="Quản lý Khách hàng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg><span class="menu-text">Quản lý Khách hàng</span></a>
      </div>

      <!-- DỊCH VỤ & THANH TOÁN -->
      <div class="menu-group">
        <div class="menu-group-title">Dịch vụ & Tài chính</div>
        <a href="{{ url_for('dich_vu_thanh_toan') }}" title="Dịch vụ & Thanh toán"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg><span class="menu-text">Dịch vụ & Thanh toán</span></a>
        <a href="{{ url_for('quan_li_hoa_don') }}" title="Quản lý Hóa đơn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg><span class="menu-text">Quản lý Hóa đơn</span></a>
        <a href="{{ url_for('thanh_toan_chua_hoan_tat') }}" title="Thanh toán chưa hoàn tất"><i class="fas fa-clock"></i><span class="menu-text">Thanh toán chưa hoàn tất</span></a>
      </div>
      
      {% if current_user.loai == 'admin' %}
      <!-- QUẢN TRỊ NHÂN SỰ (ADMIN) -->
      <div class="menu-group">
        <div class="menu-group-title">Quản trị Nhân sự</div>
        <a href="{{ url_for('nhan_vien') }}" title="Quản lý Nhân viên"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg><span class="menu-text">Quản lý Nhân viên</span></a>
        <a href="{{ url_for('cai_dat_luong_thuong') }}" title="Cài đặt lương thưởng"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a2 2 0 0 1 2 2v14l-4-2-4 2-4-2-4 2V5a2 2 0 0 1 2-2z"></path><path d="M9 8h6"></path><path d="M9 12h6"></path></svg><span class="menu-text">Cài đặt lương thưởng</span></a>
      </div>

      <!-- CÀI ĐẶT HỆ THỐNG (ADMIN) -->
      <div class="menu-group">
        <div class="menu-group-title">Cấu hình Hệ thống</div>
        <a href="{{ url_for('cai_dat_email') }}" title="Cấu hình Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><span class="menu-text">Cấu hình Email</span></a>
        <a href="{{ url_for('lich_su_email') }}" title="Lịch sử Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline><path d="M12 13v3"></path><circle cx="12" cy="9" r="1"></circle></svg><span class="menu-text">Lịch sử Email</span></a>
        <a href="{{ url_for('quan_li_dich_vu') }}" title="Quản lý Dịch vụ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg><span class="menu-text">Quản lý Dịch vụ</span></a>
      </div>

      <!-- THỐNG KÊ & BÁO CÁO (ADMIN) -->
      <div class="menu-group">
        <div class="menu-group-title">Thống kê & Báo cáo</div>
        <a href="{{ url_for('thong_ke_doanh_thu') }}" title="Thống kê Doanh thu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg><span class="menu-text">Thống kê Doanh thu</span></a>
      </div>
      {% endif %}
      
      {% endif %}
    </nav>
  </aside>

  <main class="main">
    <header class="page-header">
      <h1>QUẢN LÍ KHÁCH SẠN</h1>
      
      <div class="user-menu">
        <button type="button" class="user-menu-trigger" aria-label="Mở menu người dùng">
          <span class="user-avatar">
            <img src="{{ url_for('static', filename=current_user.avatar_path) }}"
                 alt="Ảnh đại diện của {{ current_user.ten }}"
                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/ttcn.png') }}';">
          </span>
          <div class="user-details">
            <span class="user-name">{{ current_user.ten }}</span>
            <span class="user-role">{{ 'Quản trị viên' if current_user.loai == 'admin' else 'Nhân viên' }}</span>
          </div>
        </button>
        <div class="dropdown-content">
          <a href="{{ url_for('thong_tin_ca_nhan') }}">Thông tin cá nhân</a>
          <a href="{{ url_for('luong_thuong') }}">Lương & thưởng</a>
          <a href="{{ url_for('logout') }}">Đăng xuất</a>
        </div>
      </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat,msg in messages %}
          <div class="alert {{cat}}" style="display:none;" data-category="{{cat}}" data-message="{{msg}}"></div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>
  
  <!-- NÂNG CẤP: HTML cho thông báo "toast" -->
  <div id="toast-container" class="toast-notification">
      <div class="toast-icon" id="toast-icon"></div>
      <div class="toast-body">
          <h4 id="toast-title"></h4>
          <p id="toast-message"></p>
      </div>
  </div>

  <!-- NÂNG CẤP: Thư viện Socket.IO và Script xử lý thời gian thực -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const toastContainer = document.getElementById('toast-container');
    const toastIcon = document.getElementById('toast-icon');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    let toastTimeout;

    function showToast(icon, title, message) {
      if (!toastContainer) { return; }
      toastIcon.innerHTML = icon || '<i class="fas fa-bell"></i>';
      toastTitle.textContent = title || '';
      toastMessage.textContent = message || '';
      toastContainer.classList.add('show');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toastContainer.classList.remove('show'), 5000);
    }

    document.addEventListener('click', function(event) {
      const userMenu = document.querySelector('.user-menu');
      if (!userMenu) { return; }
      if (userMenu.contains(event.target)) {
        if (event.target.closest('.user-menu-trigger')) {
          userMenu.classList.toggle('active');
        }
      } else {
        userMenu.classList.remove('active');
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof window === 'undefined' || !window.localStorage) { return; }
      const menuLinks = document.querySelector('.menu-links');
      if (!menuLinks) { return; }
      const storageKey = 'menuLinksScrollTop';

      let savedScroll = null;
      try {
        savedScroll = localStorage.getItem(storageKey);
      } catch (err) {
        console.warn('Khong the truy cap localStorage de khoi phuc vi tri menu:', err);
        return;
      }

      if (savedScroll !== null) {
        const parsed = parseInt(savedScroll, 10);
        if (!Number.isNaN(parsed)) {
          const maxScroll = Math.max(0, menuLinks.scrollHeight - menuLinks.clientHeight);
          menuLinks.scrollTop = Math.min(Math.max(parsed, 0), maxScroll);
        }
      }

      const schedule = typeof window.requestAnimationFrame === 'function'
        ? window.requestAnimationFrame.bind(window)
        : function(callback) { return setTimeout(callback, 0); };
      const cancelSchedule = typeof window.cancelAnimationFrame === 'function'
        ? window.cancelAnimationFrame.bind(window)
        : clearTimeout;

      let rafId = null;
      const rememberScroll = () => {
        rafId = null;
        try {
          localStorage.setItem(storageKey, String(Math.round(menuLinks.scrollTop)));
        } catch (err) {
          console.warn('Khong the luu vi tri thanh truy cap nhanh:', err);
        }
      };

      menuLinks.addEventListener('scroll', () => {
        if (rafId !== null) {
          cancelSchedule(rafId);
        }
        rafId = schedule(rememberScroll);
      });

      menuLinks.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', rememberScroll);
      });

      window.addEventListener('beforeunload', rememberScroll);
    });

    // --- Realtime WebSocket helpers ---
    const messageCountEndpoint = "{{ url_for('api_dem_tin_nhan_chua_doc') }}";
    const messageLinkSelector = 'a[href="{{ url_for('tin_nhan') }}"]';
    const onlineCountEndpoint = "{{ url_for('api_pending_online_count') }}";
    const onlineLinkSelector = 'a[href="{{ url_for('quan_ly_dat_phong_online') }}"]';

    function updateMessageBadge() {
        const tinNhanLink = document.querySelector(messageLinkSelector);
        if (!tinNhanLink) { return; }
        fetch(messageCountEndpoint, { cache: 'no-store' })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => {
                const currentBadges = tinNhanLink.querySelectorAll('.notification-badge');
                currentBadges.forEach(node => node.remove());

                if (data.count > 0) {
                    if (!tinNhanLink.classList.contains('menu-link-with-badge')) {
                        tinNhanLink.classList.add('menu-link-with-badge');
                    }
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = data.count < 100 ? data.count : '99+';
                    tinNhanLink.appendChild(badge);
                } else {
                    tinNhanLink.classList.remove('menu-link-with-badge');
                }
            })
            .catch(err => console.error('Không thể cập nhật badge tin nhắn:', err));
    }

    function updateOnlineBookingBadge() {
        const onlineLink = document.querySelector(onlineLinkSelector);
        if (!onlineLink) { return; }
        fetch(onlineCountEndpoint, { cache: 'no-store' })
            .then(res => res.ok ? res.json() : Promise.reject(res))
            .then(data => {
                const badge = onlineLink.querySelector('.menu-badge');
                if (data.count > 0) {
                    if (!onlineLink.classList.contains('menu-link-with-badge')) {
                        onlineLink.classList.add('menu-link-with-badge');
                    }
                    if (badge) {
                        badge.textContent = data.count < 100 ? data.count : '99+';
                    } else {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'menu-badge';
                        newBadge.textContent = data.count < 100 ? data.count : '99+';
                        onlineLink.appendChild(newBadge);
                    }
                } else {
                    if (badge) { badge.remove(); }
                    onlineLink.classList.remove('menu-link-with-badge');
                }
            })
            .catch(err => console.error('Không thể cập nhật badge đặt phòng online:', err));
    }

    updateMessageBadge();
    updateOnlineBookingBadge();

    const socket = io();

    socket.on('connect', function() {
        console.log('Connected to WebSocket server!');
    });

    socket.on('new_message_from_guest', function(data) {
        showToast('&#128172;', 'Tin nhắn mới', `Phòng ${data.phong}: "${data.noi_dung}"`);
        updateMessageBadge();
    });

    socket.on('online_booking_deposit_request', function(data) {
        showToast('&#128179;', 'Yêu cầu xác nhận cọc', `Khách ${data.khach} báo đã thanh toán.`);
        updateOnlineBookingBadge();
        updateMessageBadge();
    });

    socket.on('online_booking_confirmed', function(data) {
        showToast('&#9989;', 'Đặt phòng online', `Đã xác nhận cọc cho ${data.khach}.`);
        updateOnlineBookingBadge();
    });

    socket.on('online_booking_rejected', function(data) {
        showToast('&#10060;', 'Đặt phòng online', `Đã từ chối yêu cầu của ${data.khach}.`);
        updateOnlineBookingBadge();
    });

    socket.on('new_booking_notification', function(data) {
        showToast('&#128276;', 'Đặt phòng mới', data.message);
        updateOnlineBookingBadge();
    });

    // Hiển thị flash messages dưới dạng toast
    document.addEventListener('DOMContentLoaded', function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        const category = alert.getAttribute('data-category');
        const message = alert.getAttribute('data-message');
        let icon = '<i class="fas fa-bell"></i>';
        let title = 'Thông báo';
        if (category === 'success') {
          icon = '<i class="fas fa-check"></i>';
          title = 'Thành công';
        } else if (category === 'danger') {
          icon = '<i class="fas fa-times"></i>';
          title = 'Lỗi';
        } else if (category === 'warning') {
          icon = '<i class="fas fa-exclamation-triangle"></i>';
          title = 'Cảnh báo';
        } else if (category === 'info') {
          icon = 'ℹ️';
          title = 'Thông tin';
        }
        showToast(icon, title, message);
      });
    });

  </script>
</body>
</html>
