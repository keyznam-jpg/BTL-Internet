{% extends "base.html" %}
{% block content %}

<h2>Quản Lí Hóa Đơn</h2>

<div class="action-bar">
  {% if current_user.loai == 'admin' %}
  <a href="{{ url_for('xuat_excel_hoa_don') }}?{{ request.query_string.decode('utf-8') }}" class="btn-export">
    <i class="fas fa-file-excel"></i> Xuất Excel
  </a>
  {% endif %}
</div>

<div class="card">
  <h3>Tìm kiếm & Lọc hóa đơn</h3>
  <form method="get" class="filter-form">
    <div class="form-group">
      <label for="khach_hang">Tên khách hàng / CMND</label>
      <input type="text" name="khach_hang" id="khach_hang" value="{{ search_values.khach_hang or '' }}">
    </div>
    <div class="form-group">
      <label for="phong">Tên phòng</label>
      <input type="text" name="phong" id="phong" value="{{ search_values.phong or '' }}">
    </div>
    <div class="form-group">
      <label for="tu_ngay">Từ ngày thanh toán</label>
      <input type="date" name="tu_ngay" id="tu_ngay" value="{{ search_values.tu_ngay or '' }}">
    </div>
    <div class="form-group">
      <label for="den_ngay">Đến ngày thanh toán</label>
      <input type="date" name="den_ngay" id="den_ngay" value="{{ search_values.den_ngay or '' }}">
    </div>
    <div class="form-actions">
      <button class="primary" type="submit">Lọc</button>
      <a href="{{ url_for('quan_li_hoa_don') }}">Bỏ lọc</a>
    </div>
  </form>
</div>

<div class="card">
  <h3>Danh sách hóa đơn đã thanh toán</h3>
  <div class="table-scroll">
    <table class="table">
    <thead>
      <tr>
        <th>Mã HĐ</th>
        <th>Khách hàng</th>
        <th>Phòng</th>
        <th>Ngày hoàn tất</th>
        <th>Trạng thái</th>
        <th>Tiền phòng</th>
        <th>Tiền dịch vụ</th>
        <th>Phí phạt</th>
        <th>Tổng cộng</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      {% for d in ds_hoa_don %}
      <tr>
        <td>{{ d.id }}</td>
        <td>{{ d.khachhang.ho_ten }} ({{d.khachhang.cmnd}})</td>
        <td>{{ d.phong.ten }}</td>
        <td>{{ d.thuc_te_tra|fmt_dt }}</td>
        <td>
          {% if d.trang_thai == 'da_thanh_toan' %}
            Đã thanh toán
          {% elif d.trang_thai == 'huy' %}
            Hủy (mất cọc)
          {% else %}
            {{ d.trang_thai }}
          {% endif %}
        </td>
        <td>{{ d.tien_phong|vnd }}</td>
        <td>{{ d.tien_dv|vnd }}</td>
        <td>{{ d.tien_phat|vnd }}</td>
        <td><strong>{{ d.tong_thanh_toan|vnd }}</strong></td>
        <td>
          {% if d.trang_thai == 'da_thanh_toan' %}
          <a class="btn-action" href="{{ url_for('in_hoa_don', dat_id=d.id) }}?return_to=quan_li_hoa_don">Xem / In lại</a>
          {% elif d.coc_da_thanh_toan %}
          <a class="btn-action" href="{{ url_for('in_hoa_don_coc', dat_id=d.id) }}?return_to=quan_li_hoa_don">Xem / In lại</a>
          {% else %}
          <a class="btn-action" href="{{ url_for('thanh_toan', dat_id=d.id) }}">Xem / In lại</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if not ds_hoa_don %}
      <tr>
        <td colspan="10" style="text-align:center;">Không tìm thấy hóa đơn nào.</td>
      </tr>
      {% endif %}
    </tbody>
    </table>
  </div>
</div>

<style>
.filter-form {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  align-items: flex-end;
}
.form-group {
  display: flex;
  flex-direction: column;
}
.form-group label {
  margin-bottom: 6px;
}
.form-group input {
  box-sizing: border-box;
  width: 100%;
  padding: 10px;
  border: 1px solid #bcd4c4;
  border-radius: 6px;
}
.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 10px;
  margin-top: 10px;
  align-items: center;
}
.form-actions button, .form-actions a {
  width: auto;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
  text-align: center;
}
.form-actions button.primary {
  background: #2f7d5a;
  color: #fff;
  border: 1px solid #2f7d5a;
  margin-top: 0; /* <-- THAY ĐỔI QUAN TRỌNG NHẤT */
}
.form-actions a {
  background: #f0f0f0;
  color: #333;
  border: 1px solid #ccc;
}
.btn-action {
  font-size: 14px;
  padding: 6px 10px;
  background: #e8f5e9;
  color: #1b5e20;
  text-decoration: none;
  border-radius: 6px;
  border: 1px solid #a5d6a7;
  display: inline-block;
}
.table-scroll {
  max-height: clamp(360px, 60vh, 680px);
  overflow: auto;
  margin-top: 16px;
  border-radius: 12px;
  scrollbar-color: rgba(47, 125, 90, 0.55) rgba(47, 125, 90, 0.12);
  scrollbar-width: thin;
}
.table-scroll::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}
.table-scroll::-webkit-scrollbar-thumb {
  background: rgba(47, 125, 90, 0.55);
  border-radius: 999px;
}
.table-scroll::-webkit-scrollbar-track {
  background: rgba(47, 125, 90, 0.12);
}
.table {
  width: 100%;
  border-collapse: collapse;
}
.table th, .table td {
  border-bottom: 1px solid #eef3ee;
  padding: 10px;
  text-align: left;
}
.table thead th {
  background: #f6fbf6;
  position: sticky;
  top: 0;
  z-index: 1;
}
.action-bar {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 20px;
}
.btn-export {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  padding: 10px 20px;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
  transition: all 0.3s ease;
}
.btn-export:hover {
  background: linear-gradient(135deg, #218838, #1aa085);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
  color: white;
  text-decoration: none;
}
.btn-export.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}
</style>

{% endblock %}
