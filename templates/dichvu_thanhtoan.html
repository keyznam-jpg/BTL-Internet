{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='service.css') }}">

<div class="service-payment-management">
  <div class="service-page-header">
    <div class="header-content">
      <h2><i class="fas fa-concierge-bell"></i> D·ªãch v·ª• & Thanh to√°n</h2>
    </div>
  </div>

  <!-- CONTENT LAYOUT -->
  <div class="content-layout">
    <!-- LEFT: ROOM SELECTION -->
    <div class="section-panel">
      <div class="panel-header">
        <h3 class="panel-title"><i class="fas fa-home"></i> Danh s√°ch Ph√≤ng</h3>
      </div>

      <!-- SEARCH & FILTER -->
      <div class="room-filter-section">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-search"></i> T√¨m ki·∫øm ph√≤ng</label>
          <input 
            type="text" 
            id="room-search" 
            class="form-control" 
            placeholder="Nh·∫≠p t√™n ph√≤ng (VD: 101, 202...)">
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-filter"></i> L·ªçc theo tr·∫°ng th√°i</label>
          <select id="room-status-filter" class="form-select">
            <option value="all"><i class="fas fa-list"></i> T·∫•t c·∫£ ph√≤ng</option>
            <option value="dang_o" selected><i class="fas fa-circle" style="color: #dc3545;"></i> ƒêang c√≥ kh√°ch</option>
            <option value="trong"><i class="fas fa-circle" style="color: #28a745;"></i> Ph√≤ng tr·ªëng</option>
            <option value="da_dat"><i class="fas fa-circle" style="color: #ffc107;"></i> ƒê√£ ƒë·∫∑t (ch∆∞a nh·∫≠n)</option>
          </select>
        </div>
      </div>

      <div
        class="selected-room-info"
        id="selected-room-info"
        data-has-room="{{ '1' if chon_dat else '0' }}"
      >
        <strong
          class="selected-room-label"
          {% if not chon_dat %}style="display:none;"{% endif %}
        >
          <i class="fas fa-check"></i> ƒêang x·ª≠ l√Ω:
        </strong>
        <div class="room-detail" id="selected-room-detail">
          {% if chon_dat %}
          <i class="fas fa-user"></i> {{ chon_dat.khachhang.ho_ten }}<br>
          <i class="fas fa-door-open"></i> {{ chon_dat.phong.ten }}
          {% else %}
          <i class="fas fa-info-circle"></i> Ch·ªçn ph√≤ng ƒëang c√≥ kh√°ch ƒë·ªÉ thao t√°c d·ªãch v·ª•.
          {% endif %}
        </div>
      </div>

      <div
        class="rooms-grid"
        id="rooms-grid"
        data-selected-phong="{{ chon_dat.phong.id if chon_dat and chon_dat.phong else '' }}"
      >
        {% for p in phongs %}
        {% set room_class = 'available' %}
        {% set room_title = 'Ph√≤ng tr·ªëng' %}
        {% if p.trang_thai == 'dang_o' %}
          {% set room_class = 'occupied' %}
          {% set room_title = 'Ph√≤ng ƒëang ·ªü - Click ƒë·ªÉ ch·ªçn' %}
        {% elif p.trang_thai == 'da_dat' %}
          {% set room_class = 'booked' %}
          {% set room_title = 'Ph√≤ng ƒë√£ ƒë·∫∑t (ch∆∞a nh·∫≠n)' %}
        {% endif %}
        <button
          type="button"
          class="room-btn {{ room_class }}"
          data-phong-id="{{ p.id }}"
          data-trang-thai="{{ p.trang_thai }}"
          title="{{ room_title }}"
        >
          {{ p.ten }}
        </button>
        {% endfor %}
      </div>
    </div>

    <!-- MIDDLE: SERVICE SELECTION -->
    <div class="section-panel">
      <div class="panel-header">
        <h3 class="panel-title"><i class="fas fa-list"></i> Ch·ªçn D·ªãch v·ª•</h3>
      </div>

      <form method="post" action="{{ url_for('them_dich_vu') }}" id="form-dv" class="service-form">
        <input type="hidden" name="dat_id" value="{{ chon_dat.id if chon_dat else '' }}" />
        <input type="hidden" name="dv_id" id="dv_id">

        <!-- Service Category -->
        <div class="form-group">
          <label class="form-label"><i class="fas fa-tag"></i> Lo·∫°i d·ªãch v·ª•</label>
          <select id="loai_id" class="form-select">
            <option value="" selected disabled>‚Äî Ch·ªçn lo·∫°i d·ªãch v·ª• ‚Äî</option>
            <option value="0"><i class="fas fa-box"></i> T·∫•t c·∫£ lo·∫°i d·ªãch v·ª•</option>
            {% for l in loais %}
            <option value="{{ l.id }}">{{ l.ten }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Service Selection -->
        <div class="form-group">
          <label class="form-label"><i class="fas fa-star"></i> D·ªãch v·ª•</label>
          <select id="dv_select" class="form-select" required>
            <option value="" selected disabled>‚Äî Ch·ªçn d·ªãch v·ª• ‚Äî</option>
          </select>
        </div>

        <!-- Filter & Sort Row -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-search"></i> T√¨m ki·∫øm</label>
            <input id="filter" class="form-input" placeholder="Nh·∫≠p t√™n d·ªãch v·ª•...">
          </div>
          <div class="form-group">
            <label class="form-label">‚ÜïÔ∏è S·∫Øp x·∫øp</label>
            <select id="sort" class="form-select">
              <option value="name">T√™n (A‚ÄìZ)</option>
              <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
              <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-dollar-sign"></i> ƒê∆°n gi√°</label>
            <input id="gia_view" class="form-input price-display" readonly placeholder="0 ƒë">
          </div>
        </div>

        <!-- Quantity & Total Row -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-hashtag"></i> S·ªë l∆∞·ª£ng</label>
            <div class="quantity-control">
              <button type="button" class="qty-btn" onclick="chgQty(-1)">‚àí</button>
              <input type="number" min="1" value="1" name="so_luong" id="so_luong" class="form-input qty-input">
              <button type="button" class="qty-btn" onclick="chgQty(1)">+</button>
            </div>
          </div>
          <div class="form-group" style="grid-column: span 2;">
            <label class="form-label"><i class="fas fa-calculator"></i> T·∫°m t√≠nh</label>
            <input id="tam_tinh" class="form-input total-display" readonly value="0 ƒë">
          </div>
        </div>

        <!-- Add Button -->
        <button id="btn-add" class="btn-add-service" type="submit" {% if not chon_dat %}disabled{% endif %}>
          <span><i class="fas fa-plus"></i></span> Th√™m D·ªãch v·ª•
        </button>

      </form>
    </div>

    <!-- RIGHT: SERVICE INVOICE -->
    <div class="section-panel">
      <div class="panel-header">
        <h3 class="panel-title">üßæ H√≥a ƒë∆°n D·ªãch v·ª•</h3>
      </div>

      <div class="invoice-table-wrapper">
        <table class="invoice-table">
        <thead>
          <tr>
            <th style="width: 40px;">STT</th>
            <th>T√™n d·ªãch v·ª•</th>
            <th style="width: 120px;">ƒê∆°n gi√°</th>
            <th style="width: 60px;">SL</th>
            <th style="width: 120px;">Th√†nh ti·ªÅn</th>
            <th style="width: 80px;">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="invoice-body">
          {% set ns = namespace(tong=0) %}
          {% if hoa_don_dv %}
            {% for r in hoa_don_dv %}
            {% set thanh = r.dichvu.gia * r.so_luong %}
            {% set ns.tong = ns.tong + thanh %}
            <tr>
              <td style="text-align: center;">{{ loop.index }}</td>
              <td><strong>{{ r.dichvu.ten }}</strong></td>
              <td>{{ r.dichvu.gia|vnd }}</td>
              <td style="text-align: center;">{{ r.so_luong }}</td>
              <td><strong>{{ thanh|vnd }}</strong></td>
              <td>
                <button
                  type="button"
                  class="btn-delete btn-remove-service"
                  data-id="{{ r.id }}"
                >
                  <i class="fas fa-trash"></i> X√≥a
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="empty-state">
                <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                <div class="empty-text">Ch∆∞a c√≥ d·ªãch v·ª• n√†o</div>
              </td>
            </tr>
          {% endif %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" style="text-align: right; font-size: 16px;">T·ªïng c·ªông:</th>
            <th colspan="2" id="invoice-total" style="font-size: 18px;">{{ ns.tong|vnd }}</th>
          </tr>
        </tfoot>
        </table>
      </div>

      <div
        class="invoice-footer"
        id="invoice-footer"
        data-base-action="{{ url_for('thanh_toan_dv', dat_id=0).rsplit('/', 1)[0] }}"
        {% if not chon_dat or hoa_don_dv|length == 0 %}style="display: none;"{% endif %}
      >
        <form
          id="payment-form"
          method="post"
          {% if chon_dat %}action="{{ url_for('thanh_toan_dv', dat_id=chon_dat.id) }}"{% endif %}
        >
          <button
            id="btn-payment"
            class="btn-payment"
            type="submit"
            {% if not chon_dat or hoa_don_dv|length == 0 %}disabled{% endif %}
          >
            <span><i class="fas fa-credit-card"></i></span> Thanh to√°n D·ªãch v·ª•
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
const initialBooking = {{ initial_booking|tojson|safe }};
const roomsGrid = document.getElementById('rooms-grid');
const roomButtons = Array.from(document.querySelectorAll('.room-btn'));
const roomSearchInput = document.getElementById('room-search');
const roomStatusFilter = document.getElementById('room-status-filter');

const selectedInfoBox = document.getElementById('selected-room-info');
const selectedLabel = selectedInfoBox ? selectedInfoBox.querySelector('.selected-room-label') : null;
const selectedDetail = document.getElementById('selected-room-detail');

const serviceForm = document.getElementById('form-dv');
const datIdInp = serviceForm ? serviceForm.querySelector('input[name="dat_id"]') : null;
const dvIdInp = document.getElementById('dv_id');
const loaiSel = document.getElementById('loai_id');
const dvSel = document.getElementById('dv_select');
const priceInp = document.getElementById('gia_view');
const qtyInp = document.getElementById('so_luong');
const sumInp = document.getElementById('tam_tinh');
const filterI = document.getElementById('filter');
const sortSel = document.getElementById('sort');
const addBtn = document.getElementById('btn-add');

const invoiceBody = document.getElementById('invoice-body');
const invoiceTotal = document.getElementById('invoice-total');
const paymentFooter = document.getElementById('invoice-footer');
const paymentForm = document.getElementById('payment-form');
const paymentButton = document.getElementById('btn-payment');
const paymentBaseAction = paymentFooter ? paymentFooter.dataset.baseAction || '' : '';

let currentBooking = initialBooking;
let SERVICES_CACHE = [];
let SERVICES_VIEW = [];

function vnd(n) {
  const amount = Number(n || 0);
  return amount.toLocaleString('vi-VN') + ' ƒë';
}

function renderSelectedRoom() {
  if (!selectedInfoBox || !selectedDetail) return;
  selectedDetail.innerHTML = '';
  if (currentBooking) {
    selectedInfoBox.dataset.hasRoom = '1';
    if (selectedLabel) selectedLabel.style.display = '';
    const nameLine = document.createElement('div');
    const nameIcon = document.createElement('i');
    nameIcon.className = 'fas fa-user';
    nameLine.appendChild(nameIcon);
    nameLine.insertAdjacentText('beforeend', ' ' + (currentBooking.khach_ten || ''));
    const roomLine = document.createElement('div');
    const roomIcon = document.createElement('i');
    roomIcon.className = 'fas fa-door-open';
    roomLine.appendChild(roomIcon);
    roomLine.insertAdjacentText('beforeend', ' ' + (currentBooking.phong_ten || ''));
    selectedDetail.appendChild(nameLine);
    selectedDetail.appendChild(roomLine);
  } else {
    selectedInfoBox.dataset.hasRoom = '0';
    if (selectedLabel) selectedLabel.style.display = 'none';
    const infoLine = document.createElement('div');
    const infoIcon = document.createElement('i');
    infoIcon.className = 'fas fa-info-circle';
    infoLine.appendChild(infoIcon);
    infoLine.insertAdjacentText('beforeend', ' Ch·ªçn ph√≤ng ƒëang c√≥ kh√°ch ƒë·ªÉ thao t√°c d·ªãch v·ª•.');
    selectedDetail.appendChild(infoLine);
  }
}

function highlightSelectedRoom() {
  const currentPhongId = currentBooking ? String(currentBooking.phong_id) : '';
  roomButtons.forEach(btn => {
    btn.classList.toggle('selected', btn.dataset.phongId === currentPhongId);
  });
  if (roomsGrid) {
    roomsGrid.dataset.selectedPhong = currentPhongId;
  }
}

function renderServices() {
  if (!invoiceBody) return;
  invoiceBody.innerHTML = '';
  const services = currentBooking && Array.isArray(currentBooking.services) ? currentBooking.services : [];
  if (!services.length) {
    const emptyRow = document.createElement('tr');
    const emptyCell = document.createElement('td');
    emptyCell.colSpan = 6;
    emptyCell.className = 'empty-state';
    emptyCell.innerHTML = '<div class="empty-icon"><i class="fas fa-inbox"></i></div><div class="empty-text">Ch∆∞a c√≥ d·ªãch v·ª• n√†o</div>';
    emptyRow.appendChild(emptyCell);
    invoiceBody.appendChild(emptyRow);
    if (invoiceTotal) invoiceTotal.textContent = vnd(0);
    return;
  }
  services.forEach((item, index) => {
    const tr = document.createElement('tr');

    const idxTd = document.createElement('td');
    idxTd.style.textAlign = 'center';
    idxTd.textContent = index + 1;
    tr.appendChild(idxTd);

    const nameTd = document.createElement('td');
    const nameStrong = document.createElement('strong');
    nameStrong.textContent = item.ten;
    nameTd.appendChild(nameStrong);
    tr.appendChild(nameTd);

    const priceTd = document.createElement('td');
    priceTd.textContent = vnd(item.gia);
    tr.appendChild(priceTd);

    const qtyTd = document.createElement('td');
    qtyTd.style.textAlign = 'center';
    qtyTd.textContent = item.so_luong;
    tr.appendChild(qtyTd);

    const sumTd = document.createElement('td');
    const sumStrong = document.createElement('strong');
    sumStrong.textContent = vnd(item.thanh_tien);
    sumTd.appendChild(sumStrong);
    tr.appendChild(sumTd);

    const actionTd = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn-delete btn-remove-service';
    delBtn.dataset.id = item.id;
    delBtn.innerHTML = '<i class="fas fa-trash"></i> X√≥a';
    actionTd.appendChild(delBtn);
    tr.appendChild(actionTd);

    invoiceBody.appendChild(tr);
  });
  if (invoiceTotal) {
    invoiceTotal.textContent = vnd(currentBooking.tong || 0);
  }
}

function paymentActionUrl(id) {
  if (!paymentBaseAction || !id) return '';
  const base = paymentBaseAction.endsWith('/') ? paymentBaseAction.slice(0, -1) : paymentBaseAction;
  return `${base}/${id}`;
}

function updatePaymentState() {
  if (!paymentFooter || !paymentForm || !paymentButton) return;
  const hasItems = currentBooking && Array.isArray(currentBooking.services) && currentBooking.services.length > 0;
  if (hasItems) {
    const action = paymentActionUrl(currentBooking.id);
    if (action) paymentForm.action = action;
    paymentFooter.style.display = 'flex';
    paymentButton.disabled = false;
  } else {
    paymentFooter.style.display = 'none';
    paymentButton.disabled = true;
  }
}

function setCurrentBooking(booking) {
  currentBooking = booking || null;
  if (datIdInp) {
    datIdInp.value = currentBooking ? currentBooking.id : '';
  }
  renderSelectedRoom();
  renderServices();
  highlightSelectedRoom();
  updateAddEnabled();
  updatePaymentState();
}

function updateAddEnabled() {
  const selected = !!(dvIdInp && dvIdInp.value);
  const hasBooking = !!currentBooking;
  if (addBtn) addBtn.disabled = !selected || !hasBooking;
}

function chgQty(delta) {
  if (!qtyInp) return;
  let v = parseInt(qtyInp.value || '1', 10) + delta;
  if (v < 1) v = 1;
  qtyInp.value = v;
  updateSubtotal();
}

function updateSubtotal() {
  if (!sumInp) return;
  const op = dvSel && dvSel.options[dvSel.selectedIndex];
  const gia = op ? Number(op.dataset.gia || 0) : 0;
  const sl = Number(qtyInp ? qtyInp.value || 1 : 1);
  sumInp.value = vnd(gia * sl);
}

function fillServicesSelect() {
  if (!dvSel) return;
  dvSel.innerHTML = '<option value="" disabled selected>‚Äî Ch·ªçn d·ªãch v·ª• ‚Äî</option>';
  SERVICES_VIEW.forEach(d => {
    const op = document.createElement('option');
    op.value = d.id;
    op.dataset.gia = d.gia;
    op.textContent = `${d.ten} ‚Äî ${vnd(d.gia)}`;
    dvSel.appendChild(op);
  });
  if (dvIdInp) dvIdInp.value = '';
  if (priceInp) priceInp.value = '';
  updateSubtotal();
  updateAddEnabled();
}

function applyFilterSort() {
  const keyword = ((filterI && filterI.value) || '').toLowerCase().trim();
  SERVICES_VIEW = SERVICES_CACHE.filter(d => d.ten.toLowerCase().includes(keyword));
  const sortValue = sortSel ? sortSel.value : 'name';
  if (sortValue === 'name') SERVICES_VIEW.sort((a, b) => a.ten.localeCompare(b.ten, 'vi'));
  if (sortValue === 'price-asc') SERVICES_VIEW.sort((a, b) => a.gia - b.gia);
  if (sortValue === 'price-desc') SERVICES_VIEW.sort((a, b) => b.gia - a.gia);
  fillServicesSelect();
}

async function loadByLoai() {
  if (!loaiSel) return;
  const loai = loaiSel.value;
  if (!loai) return;
  try {
    const res = await fetch('/api/dichvu-theo-loai/' + loai);
    if (!res.ok) throw new Error('Failed to load services');
    SERVICES_CACHE = await res.json();
    applyFilterSort();
  } catch (error) {
    console.error(error);
    SERVICES_CACHE = [];
    SERVICES_VIEW = [];
    fillServicesSelect();
  }
}

function filterRooms() {
  const searchText = ((roomSearchInput && roomSearchInput.value) || '').toLowerCase().trim();
  const statusFilter = roomStatusFilter ? roomStatusFilter.value : 'all';
  let visibleCount = 0;

  roomButtons.forEach(btn => {
    const roomName = btn.textContent.trim().toLowerCase();
    const roomStatus = btn.dataset.trangThai;
    const matchesSearch = !searchText || roomName.includes(searchText);

    let matchesStatus = false;
    if (statusFilter === 'all') {
      matchesStatus = true;
    } else if (statusFilter === 'trong') {
      matchesStatus = roomStatus !== 'dang_o' && roomStatus !== 'da_dat';
    } else {
      matchesStatus = roomStatus === statusFilter;
    }

    if (matchesSearch && matchesStatus) {
      btn.style.display = '';
      visibleCount++;
    } else {
      btn.style.display = 'none';
    }
  });

  if (!roomsGrid) return;
  let noResultMsg = roomsGrid.querySelector('.no-rooms-message');
  if (visibleCount === 0) {
    if (!noResultMsg) {
      noResultMsg = document.createElement('div');
      noResultMsg.className = 'no-rooms-message';
      noResultMsg.textContent = 'Kh√¥ng t√¨m th·∫•y ph√≤ng ph√π h·ª£p';
      roomsGrid.appendChild(noResultMsg);
    }
  } else if (noResultMsg) {
    noResultMsg.remove();
  }
}

async function selectPhong(pid) {
  if (!pid) return;
  try {
    const res = await fetch('/api/dat-theo-phong/' + pid);
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert(data.error || 'Ph√≤ng ch∆∞a c√≥ kh√°ch ƒëang thu√™.');
      return;
    }
    setCurrentBooking(data.booking);
  } catch (error) {
    console.error(error);
    alert('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng.');
  }
}

async function addService(event) {
  event.preventDefault();
  if (!serviceForm) return;
  if (!dvIdInp || !dvIdInp.value) {
    alert('Vui l√≤ng ch·ªçn d·ªãch v·ª• tr∆∞·ªõc khi th√™m.');
    return;
  }
  if (!currentBooking) {
    alert('Vui l√≤ng ch·ªçn ph√≤ng ƒëang s·ª≠ d·ª•ng tr∆∞·ªõc khi th√™m d·ªãch v·ª•.');
    return;
  }
  const formData = new FormData(serviceForm);
  try {
    if (addBtn) addBtn.disabled = true;
    const res = await fetch(serviceForm.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert(data.message || 'Kh√¥ng th·ªÉ th√™m d·ªãch v·ª•.');
      return;
    }
    setCurrentBooking(data.booking);
    if (qtyInp) {
      qtyInp.value = '1';
    }
    updateSubtotal();
  } catch (error) {
    console.error(error);
    alert('C√≥ l·ªói khi th√™m d·ªãch v·ª•.');
  } finally {
    updateAddEnabled();
  }
}

async function handleDeleteService(event) {
  const btn = event.target.closest('.btn-remove-service');
  if (!btn) return;
  event.preventDefault();
  const id = btn.dataset.id;
  if (!id) return;
  if (!currentBooking) return;
  if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªãch v·ª• n√†y?')) return;
  try {
    const res = await fetch('/xoa-sudung-dichvu/' + id, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert(data.message || 'Kh√¥ng th·ªÉ x√≥a d·ªãch v·ª•.');
      return;
    }
    setCurrentBooking(data.booking);
  } catch (error) {
    console.error(error);
    alert('C√≥ l·ªói khi x√≥a d·ªãch v·ª•.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  if (loaiSel) {
    if (!loaiSel.value && loaiSel.querySelector('option[value="0"]')) {
      loaiSel.value = '0';
    }
    loadByLoai();
  }

  roomButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const status = btn.dataset.trangThai;
      if (status === 'dang_o') {
        selectPhong(btn.dataset.phongId);
      } else if (status === 'da_dat') {
        alert('Ph√≤ng ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t nh∆∞ng ch∆∞a nh·∫≠n. Kh√¥ng th·ªÉ th√™m d·ªãch v·ª•.');
      } else {
        alert('Ph√≤ng hi·ªán ch∆∞a c√≥ kh√°ch.');
      }
    });
  });

  if (roomSearchInput) {
    roomSearchInput.addEventListener('input', filterRooms);
  }
  if (roomStatusFilter) {
    roomStatusFilter.addEventListener('change', filterRooms);
  }
  filterRooms();

  if (filterI) {
    filterI.addEventListener('input', applyFilterSort);
  }
  if (sortSel) {
    sortSel.addEventListener('change', applyFilterSort);
  }

  if (dvSel) {
    dvSel.addEventListener('change', () => {
      const op = dvSel.options[dvSel.selectedIndex];
      if (!op) return;
      if (dvIdInp) dvIdInp.value = op.value;
      if (priceInp) priceInp.value = vnd(Number(op.dataset.gia || 0));
      updateSubtotal();
      updateAddEnabled();
    });
  }

  if (qtyInp) {
    qtyInp.addEventListener('input', updateSubtotal);
  }

  if (serviceForm) {
    serviceForm.addEventListener('submit', addService);
  }

  if (invoiceBody) {
    invoiceBody.addEventListener('click', handleDeleteService);
  }

  setCurrentBooking(initialBooking || null);
  updateSubtotal();
});
</script>

{% endblock %}
